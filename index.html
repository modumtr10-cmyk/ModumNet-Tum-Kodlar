<!DOCTYPE html>
<html lang="tr">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ModumNet | Y√∂netici Paneli</title>
    <link
      rel="icon"
      href="https://www.modum.tr/i/m/001/0013355.png"
      type="image/png"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #4361ee;
        --secondary: #3f37c9;
        --success: #06d6a0;
        --info: #4895ef;
        --warning: #f72585;
        --danger: #e63946;
        --dark: #0f172a;
        --dark-light: #1e293b;
        --light: #f8fafc;
        --white: #ffffff;
        --text-gray: #94a3b8;
        --border-color: #e2e8f0;
      }

      body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background-color: var(--light);
        display: flex;
        height: 100vh;
        overflow: hidden;
        font-size: 13px;
        color: #334155;
      }

      /* SCROLLBAR */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* SIDEBAR */
      .sidebar {
        width: 280px;
        background-color: var(--dark);
        color: var(--white);
        display: flex;
        flex-direction: column;
        transition: 0.3s;
        flex-shrink: 0;
        overflow-y: auto;
      }

      .sidebar-brand {
        height: 70px;
        display: flex;
        align-items: center;
        padding: 0 25px;
        font-size: 1.2rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        background-color: var(--dark-light);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--white);
      }
      .sidebar-brand span {
        color: var(--primary);
        margin-left: 5px;
      }

      .sidebar-group {
        padding: 20px 25px 5px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        letter-spacing: 1px;
      }

      .nav-item {
        padding: 10px 25px;
        color: #94a3b8;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.9rem;
        border-left: 3px solid transparent;
      }

      .nav-item i {
        width: 25px;
        font-size: 1.1em;
        text-align: center;
        margin-right: 8px;
        opacity: 0.7;
      }

      .nav-item:hover {
        color: var(--white);
        background-color: rgba(255, 255, 255, 0.05);
      }

      .nav-item.active {
        color: var(--white);
        background: linear-gradient(
          90deg,
          rgba(67, 97, 238, 0.15) 0%,
          rgba(67, 97, 238, 0) 100%
        );
        border-left-color: var(--primary);
      }
      .nav-item.active i {
        color: var(--primary);
        opacity: 1;
      }

      /* CONTENT */
      .content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .topbar {
        height: 70px;
        background-color: var(--white);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        z-index: 10;
      }

      .page-title h3 {
        margin: 0;
        font-weight: 700;
        color: var(--dark);
        font-size: 1.25rem;
      }
      .page-title p {
        margin: 2px 0 0;
        color: #64748b;
        font-size: 0.85rem;
      }

      .api-status {
        font-size: 0.75rem;
        color: var(--success);
        background: rgba(6, 214, 160, 0.1);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .main-content {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
      }

      .page-section {
        display: none;
      }
      .page-section.active {
        display: block;
        animation: fadeIn 0.3s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* COMPONENTS */
      .card {
        background: var(--white);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .stat-card {
        background: var(--white);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
      }
      .bg-blue-light {
        background: #e0e7ff;
        color: var(--primary);
      }
      .bg-green-light {
        background: #dcfce7;
        color: var(--success);
      }
      .bg-pink-light {
        background: #fce7f3;
        color: var(--warning);
      }
      .bg-purple-light {
        background: #f3e8ff;
        color: #9333ea;
      }

      .stat-info h4 {
        margin: 0;
        font-size: 0.75rem;
        color: #94a3b8;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-info .value {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--dark);
        margin-top: 5px;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .table-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
      }
      th {
        text-align: left;
        padding: 15px;
        background: #f1f5f9;
        color: #475569;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        border-bottom: 1px solid var(--border-color);
      }
      td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
      }
      tr:hover td {
        background-color: #f8fafc;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: 0.2s;
        justify-content: center;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.2);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-warning {
        background: var(--warning);
        color: white;
      }
      .btn-dark {
        background: var(--dark);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid #cbd5e1;
        color: #475569;
      }
      .btn-outline:hover {
        border-color: var(--primary);
        color: var(--primary);
      }

      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        display: inline-block;
      }
      .badge-success {
        background: #dcfce7;
        color: #166534;
      }
      .badge-warning {
        background: #fef9c3;
        color: #854d0e;
      }
      .badge-danger {
        background: #fee2e2;
        color: #991b1b;
      }
      .badge-info {
        background: #e0f2fe;
        color: #075985;
      }

      /* DASHBOARD SPECIFIC */
      .quick-actions {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
      }
      .action-btn {
        background: white;
        border: 1px solid var(--border-color);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        color: var(--dark);
        font-weight: 600;
      }
      .action-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
      }
      .action-btn i {
        font-size: 1.5rem;
        color: var(--primary);
      }

      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
      }
      .todo-item:last-child {
        border-bottom: none;
      }
      .todo-check {
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .todo-check.checked {
        background: var(--success);
        border-color: var(--success);
        color: white;
      }

      .log-item {
        padding: 12px 0;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .log-icon {
        width: 36px;
        height: 36px;
        background: #f1f5f9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        font-size: 0.9rem;
        flex-shrink: 0;
      }
      .log-content div {
        font-weight: 600;
        color: var(--dark);
        font-size: 0.9rem;
      }
      .log-content small {
        color: #94a3b8;
      }

      /* MODALS */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(15, 23, 42, 0.6);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: white;
        width: 500px;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        outline: none;
        box-sizing: border-box;
      }
      .form-group input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }
      /* DASHBOARD YENƒ∞ TASARIM */
      .dash-card-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }
      .dash-big-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-top: 4px solid var(--primary);
      }
      .dash-list-item {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
      }

      /* TABLO YAPISI (Y√∂netici Notlarƒ±) */
      .tab-header {
        display: flex;
        border-bottom: 2px solid #eee;
        margin-bottom: 15px;
      }
      .tab-btn {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        color: #94a3b8;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .task-row {
        display: flex;
        align-items: center;
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #e2e8f0;
      }
      .task-checkbox {
        width: 20px;
        height: 20px;
        margin-right: 15px;
        cursor: pointer;
      }
      .task-tag {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        color: white;
        margin-left: 10px;
        text-transform: uppercase;
      }
      /* LOGIN EKRANI TASARIMI */
      #login-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .login-box {
        background: white;
        padding: 40px;
        border-radius: 12px;
        width: 350px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      }
      .login-box h2 {
        color: #0f172a;
        margin-bottom: 20px;
      }
      .login-box input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .login-box button {
        width: 100%;
        padding: 12px;
        background: #4361ee;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
      }
      .login-box button:hover {
        background: #3f37c9;
      }

      /* PANELƒ∞ Gƒ∞ZLEMEK ƒ∞√áƒ∞N */
      #app-container {
        display: none;
      }
      /* Modalƒ± zorla g√∂r√ºn√ºr yap */
      #modalRaffle.show {
        display: flex !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
      /* --- ANAHTAR (SWITCH) BUTONU TASARIMI --- */
      .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
        vertical-align: middle;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #10b981; /* ONAYLIYSA YE≈ûƒ∞L OLSUN */
      }
      input:checked + .slider:before {
        transform: translateX(14px);
      }
    </style>
  </head>
  <body>
    <!-- üîí Gƒ∞Rƒ∞≈û EKRANI (EN √úSTTE) -->
    <div id="login-screen">
      <div class="login-box">
        <div style="font-size: 3rem; color: #4361ee; margin-bottom: 10px">
          <i class="fas fa-shield-alt"></i>
        </div>
        <h2>ModumNet Admin</h2>
        <input type="email" id="loginEmail" placeholder="E-posta Adresi" />
        <input type="password" id="loginPass" placeholder="≈ûifre" />
        <button onclick="doLogin()">Gƒ∞Rƒ∞≈û YAP</button>
        <p
          id="loginMsg"
          style="color: red; margin-top: 10px; font-size: 0.9rem"
        ></p>
      </div>
    </div>

    <!-- üîì ANA PANEL (Gƒ∞ZLƒ∞ BA≈ûLAR) -->
    <div id="app-container" style="display: flex; width: 100%; height: 100%">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="sidebar-brand">
          <i class="fas fa-cubes"></i> <span>MODUMNET</span>
        </div>

        <!-- ANA SAYFA -->
        <a
          class="nav-item active"
          onclick="showPage('dashboard', 'Patron Paneli', 'G√ºnl√ºk √ñzet ve Hƒ±zlƒ± ƒ∞≈ülemler')"
        >
          <i class="fas fa-home"></i> Patron Paneli
        </a>

        <!-- M√ú≈ûTERƒ∞ & CRM -->
        <div class="sidebar-group">M√º≈üteri & CRM</div>
        <a
          class="nav-item"
          onclick="showPage('users', 'Kullanƒ±cƒ±lar (#4)', '√úyeler, Puanlar, Seviyeler')"
        >
          <i class="fas fa-users"></i> Kullanƒ±cƒ±lar
        </a>
        <a
          class="nav-item"
          onclick="showPage('referrals', 'Referanslar (#11)', 'Davet Sistemi ve Kazan√ßlar')"
        >
          <i class="fas fa-user-friends"></i> Referanslar
        </a>
        <a
          class="nav-item"
          onclick="showPage('pointHistory', 'Puan Ge√ßmi≈üi (#5)', 'Kazanƒ±lan ve Harcanan Puanlar')"
        >
          <i class="fas fa-history"></i> Puan Ge√ßmi≈üi
        </a>
        <a
          class="nav-item"
          onclick="showPage('participants', 'Katƒ±lƒ±mcƒ±lar (#1)', 'Aktif √áekili≈ü Biletleri')"
        >
          <i class="fas fa-ticket-alt"></i> Katƒ±lƒ±mcƒ±lar
        </a>
        <a
          class="nav-item"
          onclick="showPage('archive', 'Ar≈üiv Katƒ±lƒ±m (#19)', 'Bitmi≈ü √áekili≈ü Kayƒ±tlarƒ±')"
        >
          <i class="fas fa-archive"></i> Ar≈üiv Katƒ±lƒ±m
        </a>

        <!-- √áEKƒ∞Lƒ∞≈û & √ñD√úL -->
        <div class="sidebar-group">√áekili≈ü & √ñd√ºl</div>
        <a
          class="nav-item"
          onclick="showPage('raffles', '√áekili≈ü Y√∂netimi (#2)', 'Kazanan Belirleme Motoru')"
        >
          <i class="fas fa-trophy"></i> √áekili≈ü Y√∂netimi
        </a>
        <a
          class="nav-item"
          onclick="showPage('winners', 'Kazananlar (#3)', 'Talihliler Listesi')"
        >
          <i class="fas fa-medal"></i> Kazananlar
        </a>
        <a
          class="nav-item"
          onclick="showPage('couponPool', 'Kupon Havuzu (#17)', 'Sistemin Daƒüƒ±ttƒ±ƒüƒ± Kodlar')"
        >
          <i class="fas fa-tags"></i> Kupon Havuzu
        </a>
        <a
          class="nav-item"
          onclick="showPage('couponStore', 'Kupon Maƒüazasƒ± (#12)', 'Puanla Satƒ±lan √úr√ºnler')"
        >
          <i class="fas fa-shopping-bag"></i> Kupon Maƒüazasƒ±
        </a>

        <!-- OYUNLA≈ûTIRMA -->
        <div class="sidebar-group">Oyunla≈ütƒ±rma</div>
        <a
          class="nav-item"
          onclick="showPage('tasks', 'G√∂rev Serileri (#8)', 'G√ºnl√ºk ve Tekil G√∂rev Tanƒ±mlarƒ±')"
        >
          <i class="fas fa-tasks"></i> G√∂rev Serileri
        </a>
        <a
          class="nav-item"
          onclick="showPage('userProgress', 'G√∂rev ƒ∞lerleme (#9)', 'Kullanƒ±cƒ± Bazlƒ± Takip')"
        >
          <i class="fas fa-chart-line"></i> G√∂rev ƒ∞lerleme
        </a>
        <a
          class="nav-item"
          onclick="showPage('productPool', '√úr√ºn Havuzu (#18)', 'Sadece Stok Kodlarƒ± (SKU)')"
        >
          <i class="fas fa-barcode"></i> √úr√ºn Havuzu (SKU)
        </a>
        <a
          class="nav-item"
          onclick="showPage('systemData', 'Sistem Verisi (#16)', 'Efsane Havuzu & Altƒ±n √úr√ºnler')"
        >
          <i class="fas fa-gem"></i> Sistem Verisi
        </a>
        <a
          class="nav-item"
          onclick="showPage('surveys', 'Anket Y√∂netimi', 'M√º≈üteri Nabzƒ±nƒ± Tutun')"
        >
          <i class="fas fa-poll"></i> Anketler
        </a>

        <!-- ƒ∞LETƒ∞≈ûƒ∞M & DESTEK -->
        <div class="sidebar-group">ƒ∞leti≈üim & Destek</div>
        <a
          class="nav-item"
          onclick="showPage('feedback', 'Geri Bildirim (#6)', 'Destek Talepleri')"
        >
          <i class="fas fa-headset"></i> Geri Bildirim
        </a>
        <a
          class="nav-item"
          onclick="showPage('notifications', 'Bildirim (#7)', 'Gelince Haber Ver Listesi')"
        >
          <i class="fas fa-bell"></i> Bildirimler
        </a>

        <!-- Sƒ∞STEM & LOG -->
        <div class="sidebar-group">G√ºvenlik & Log</div>
        <a
          class="nav-item"
          onclick="showPage('settings', 'Ayarlar (#10)', 'XP Oranlarƒ± ve Seviye Sƒ±nƒ±rlarƒ±')"
        >
          <i class="fas fa-cog"></i> Ayarlar
        </a>
        <a
          class="nav-item"
          onclick="showPage('systemLogs', 'Sistem Loglarƒ± (#13)', 'Kullanƒ±cƒ± Tƒ±klama Ge√ßmi≈üi')"
        >
          <i class="fas fa-file-alt"></i> Sistem Loglarƒ±
        </a>
        <a
          class="nav-item"
          onclick="showPage('securityLogs', 'G√ºvenlik Loglarƒ± (#15)', 'IP ve ƒ∞≈ülem Sƒ±nƒ±rlarƒ±')"
        >
          <i class="fas fa-shield-alt"></i> G√ºvenlik Loglarƒ±
        </a>
        <a
          class="nav-item"
          onclick="showPage('logger', 'Logger (#14)', 'Hata Kayƒ±tlarƒ±')"
        >
          <i class="fas fa-bug"></i> Logger (Hata)
        </a>

        <div style="margin-top: auto; padding: 20px">
          <input
            type="text"
            id="apiUrlInput"
            value="https://api-hjen5442oq-uc.a.run.app"
            style="
              background: #1e293b;
              border: 1px solid #334155;
              color: #94a3b8;
              width: 100%;
              padding: 5px;
              font-size: 10px;
            "
          />
        </div>
      </div>

      <div class="content-wrapper">
        <div class="topbar">
          <div class="page-title">
            <h3 id="header-title">Patron Paneli</h3>
            <p id="header-desc">G√ºnl√ºk √ñzet ve Hƒ±zlƒ± ƒ∞≈ülemler</p>
          </div>
          <!-- üî• HEADER TEMA SE√áƒ∞Cƒ∞ (Sadece Ayarlar Sayfasƒ±nda G√∂r√ºn√ºr) -->
          <div
            id="header-theme-area"
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              margin-left: auto;
              margin-right: 30px;
              background: #f1f5f9;
              padding: 5px 10px;
              border-radius: 8px;
              border: 1px solid #cbd5e1;
            "
          >
            <i class="fas fa-palette" style="color: #64748b"></i>
            <select
              id="set_active_theme"
              style="
                padding: 6px;
                border-radius: 5px;
                border: 1px solid #ccc;
                font-size: 12px;
                outline: none;
                background: white;
                color: #334155;
                font-weight: 600;
              "
            >
              <option value="default">üåë Varsayƒ±lan</option>
              <option value="newyear">üéÑ Yƒ±lba≈üƒ±</option>
              <option value="valentines">üíò Sevgililer G√ºn√º</option>
              <option value="ramadan">üåô Ramazan</option>
              <option value="summer">‚òÄÔ∏è Yaz Modu</option>
            </select>
            <button
              onclick="saveThemeOnly()"
              class="btn btn-primary btn-sm"
              style="
                padding: 6px 12px;
                font-size: 11px;
                background: #8b5cf6;
                border: none;
              "
            >
              Kaydet
            </button>
          </div>
          <!-- √áIKI≈û BUTONU EKLE -->
          <div style="display: flex; gap: 10px; align-items: center">
            <div class="api-status">Sistem Aktif</div>
            <div
              style="
                display: flex;
                align-items: center;
                margin-right: 20px;
                background: rgba(0, 0, 0, 0.05);
                padding: 5px 15px;
                border-radius: 50px;
              "
            >
              <span
                id="maint_label"
                style="
                  font-weight: bold;
                  font-size: 13px;
                  margin-right: 10px;
                  color: #10b981;
                "
              >
                üü¢ Sƒ∞TE AKTƒ∞F
              </span>
              <label
                class="switch"
                style="
                  position: relative;
                  display: inline-block;
                  width: 40px;
                  height: 22px;
                  margin-bottom: 0;
                "
              >
                <input
                  type="checkbox"
                  id="header_maint_toggle"
                  onchange="toggleMaintenanceHeader()"
                />
                <span
                  class="slider round"
                  style="
                    position: absolute;
                    cursor: pointer;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background-color: #ccc;
                    transition: 0.4s;
                    border-radius: 34px;
                  "
                ></span>
                <style>
                  .switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                  }
                  .slider.round:before {
                    position: absolute;
                    content: "";
                    height: 16px;
                    width: 16px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: 0.4s;
                    border-radius: 50%;
                  }
                  input:checked + .slider {
                    background-color: #ef4444;
                  } /* Kƒ±rmƒ±zƒ± (Bakƒ±m) */
                  input:checked + .slider:before {
                    transform: translateX(18px);
                  }
                </style>
              </label>
            </div>
            <button
              onclick="doLogout()"
              class="btn btn-sm btn-danger"
              style="background: #e63946; color: white; border: none"
            >
              <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü
            </button>
          </div>
        </div>

        <div class="main-content">
          <div id="page-dashboard" class="page-section active">
            <!-- √úST KISIM: CANLI VERƒ∞LER -->
            <div
              style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px"
            >
              <!-- SOL: CANLI ƒ∞STATƒ∞STƒ∞KLER (Screenshot 44 Gibi) -->
              <div class="card">
                <div class="table-header">
                  <h5 style="color: #1e293b">
                    üìä PATRON PANELƒ∞
                    <span class="badge badge-danger">CANLI</span>
                  </h5>
                  <button
                    class="btn btn-outline btn-sm"
                    onclick="loadDashboard()"
                  >
                    <i class="fas fa-sync"></i>
                  </button>
                </div>

                <!-- 4 B√úY√úK KUTU -->
                <div class="dash-card-grid">
                  <div class="dash-big-card" style="border-top-color: #3b82f6">
                    <h2 id="d-goruntulenme">0</h2>
                    <small style="color: #64748b">G√ñR√úNT√úLENME</small>
                  </div>
                  <div class="dash-big-card" style="border-top-color: #10b981">
                    <h2 id="d-aktifuye">0</h2>
                    <small style="color: #64748b">AKTƒ∞F √úYE</small>
                  </div>
                  <div class="dash-big-card" style="border-top-color: #f59e0b">
                    <h2 id="d-dagitilanxp">0</h2>
                    <small style="color: #64748b">DAƒûITILAN XP</small>
                  </div>
                  <div class="dash-big-card" style="border-top-color: #ef4444">
                    <h2 id="d-verilenhak">0</h2>
                    <small style="color: #64748b">VERƒ∞LEN HAK</small>
                  </div>
                </div>

                <!-- Lƒ∞STE DETAYLARI -->
                <div
                  style="background: #f8fafc; border-radius: 8px; padding: 10px"
                >
                  <div class="dash-list-item">
                    <span>üéüÔ∏è √áekili≈üe Katƒ±lƒ±m</span> <b id="d-cekilis">0</b>
                  </div>
                  <div class="dash-list-item">
                    <span>üõçÔ∏è Maƒüaza Satƒ±≈üƒ±</span> <b id="d-magaza">0</b>
                  </div>
                  <div class="dash-list-item">
                    <span>üéÅ ≈ûans Kutusu</span> <b id="d-kutu">0</b>
                  </div>
                  <div class="dash-list-item">
                    <span>üöÄ Tamamlanan G√∂rev</span> <b id="d-gorev">0</b>
                  </div>
                  <div class="dash-list-item">
                    <span>üïµÔ∏è Gizli Hazine</span> <b id="d-hazine">0</b>
                  </div>
                  <div class="dash-list-item">
                    <span>üéÇ Doƒüum G√ºn√º</span> <b id="d-dogum">0</b>
                  </div>
                </div>
              </div>

              <!-- SAƒû: Y√ñNETƒ∞Cƒ∞ NOTLARI (TABLI Sƒ∞STEM) -->
              <div class="card">
                <div class="table-header">
                  <h5>üëã Ho≈ügeldin Patron! Bug√ºn Ne Yapƒ±yoruz?</h5>
                </div>

                <!-- TAB MEN√úS√ú -->
                <div class="tab-header">
                  <div class="tab-btn active" onclick="openTab('tab-daily')">
                    ‚òÄÔ∏è G√úNL√úK
                  </div>
                  <div class="tab-btn" onclick="openTab('tab-weekly')">
                    üìÖ HAFTALIK
                  </div>
                  <div class="tab-btn" onclick="openTab('tab-monthly')">
                    üóìÔ∏è AYLIK
                  </div>
                </div>

                <!-- G√úNL√úK ƒ∞≈ûLER -->
                <div id="tab-daily" class="tab-content active">
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-d-1"
                      onchange="toggleNote('daily', 1)"
                    />
                    <div>
                      <b>1. G√ºn√ºn ≈ûifresini Belirle</b>
                      <span class="task-tag" style="background: #10b981"
                        >Ayarlar</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Ayarlar sayfasƒ±na bug√ºn√ºn ≈üifresini yaz.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-d-2"
                      onchange="toggleNote('daily', 2)"
                    />
                    <div>
                      <b>2. Instagram Hikayesi At</b>
                      <span class="task-tag" style="background: #e1306c"
                        >Instagram</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Kodu hikayede payla≈ü.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-d-3"
                      onchange="toggleNote('daily', 3)"
                    />
                    <div>
                      <b>3. Altƒ±n √úr√ºn Kontrol√º</b>
                      <span class="task-tag" style="background: #f59e0b"
                        >Sistem</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        SistemVerisi sayfasƒ±nƒ± kontrol et.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- HAFTALIK ƒ∞≈ûLER -->
                <div id="tab-weekly" class="tab-content">
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-w-1"
                      onchange="toggleNote('weekly', 1)"
                    />
                    <div>
                      <b>1. Faprika Kuponlarƒ±</b>
                      <span class="task-tag" style="background: #f97316"
                        >Faprika</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Bu haftanƒ±n indirim kuponlarƒ±nƒ± olu≈ütur.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-w-2"
                      onchange="toggleNote('weekly', 2)"
                    />
                    <div>
                      <b>2. Havuzu Doldur</b>
                      <span class="task-tag" style="background: #10b981"
                        >Sihirbaz</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Kuponlarƒ± havuza ekle.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-w-3"
                      onchange="toggleNote('weekly', 3)"
                    />
                    <div>
                      <b>3. Yeni √áekili≈ü Kur</b>
                      <span class="task-tag" style="background: #3b82f6"
                        >√áekili≈ü</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Yeni √ßekili≈üi ba≈ülat.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-w-4"
                      onchange="toggleNote('weekly', 4)"
                    />
                    <div>
                      <b>4. Bildirim G√∂nder</b>
                      <span class="task-tag" style="background: #6366f1"
                        >Duyuru</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        √úyelere mail at.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- AYLIK ƒ∞≈ûLER -->
                <div id="tab-monthly" class="tab-content">
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-m-1"
                      onchange="toggleNote('monthly', 1)"
                    />
                    <div>
                      <b>1. Efsane √ñd√ºl√º</b>
                      <span class="task-tag" style="background: #8b5cf6"
                        >Patron</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        En y√ºksek puanlƒ±ya b√ºy√ºk √∂d√ºl√º ver.
                      </div>
                    </div>
                  </div>
                  <div class="task-row">
                    <input
                      type="checkbox"
                      class="task-checkbox"
                      id="task-m-2"
                      onchange="toggleNote('monthly', 2)"
                    />
                    <div>
                      <b>2. √úr√ºn Havuzu Temizliƒüi</b>
                      <span class="task-tag" style="background: #ef4444"
                        >Havuz</span
                      >
                      <div style="font-size: 0.8rem; color: #64748b">
                        Eski √ºr√ºnleri sil.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ALT KISIM: HIZLI BUTONLAR (Eskisi Gibi) -->
            <h4 style="margin: 20px 0 15px 0; color: #64748b">
              Hƒ±zlƒ± ƒ∞≈ülemler
            </h4>
            <div class="quick-actions">
              <div class="action-btn" onclick="openModal('modalGivePoint')">
                <i class="fas fa-star"></i> Puan Ver / Sil
              </div>
              <div
                class="action-btn"
                onclick="showPage('notifications', 'Bildirimler', 'Duyuru G√∂nder')"
              >
                <i class="fas fa-paper-plane"></i> Duyuru G√∂nder
              </div>
              <div
                class="action-btn"
                onclick="showPage('raffles', '√áekili≈ü Y√∂netimi', 'Yeni √áekili≈ü')"
              >
                <i class="fas fa-ticket-alt"></i> √áekili≈ü Ba≈ülat
              </div>
              <div class="action-btn" onclick="simulateOrder()">
                <i class="fas fa-shopping-basket" style="color: #e67e22"></i>
                Sipari≈ü Testi
              </div>
            </div>
          </div>
          <div id="page-surveys" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Aktif ve Ge√ßmi≈ü Anketler</h5>

                <button
                  class="btn btn-primary btn-sm"
                  onclick="openModal('modalCreateSurvey')"
                >
                  <i class="fas fa-plus"></i> Yeni Anket
                </button>
              </div>

              <table id="table-surveys">
                <thead>
                  <tr>
                    <th>Soru</th>
                    <th>Sonu√ßlar (Daƒüƒ±lƒ±m)</th>
                    <th>Toplam</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>

                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-users" class="page-section">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-info">
                  <h4>Toplam √úye</h4>
                  <div class="value" id="stat-total-users">-</div>
                </div>
                <div class="stat-icon bg-blue-light">
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-info">
                  <h4>Toplam Puan</h4>
                  <div class="value" id="stat-total-xp">-</div>
                </div>
                <div class="stat-icon bg-green-light">
                  <i class="fas fa-star"></i>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>M√º≈üteri Listesi</h5>
                <div style="display: flex; gap: 5px; margin-left: auto">
                  <input
                    type="text"
                    id="userSearchInput"
                    placeholder="E-posta ara..."
                    style="
                      padding: 5px 10px;
                      border: 1px solid #cbd5e1;
                      border-radius: 6px;
                      font-size: 12px;
                      width: 200px;
                    "
                  />
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="searchUsers()"
                  >
                    Ara
                  </button>
                  <button
                    class="btn btn-outline btn-sm"
                    onclick="clearUserSearch()"
                  >
                    Sil
                  </button>
                </div>
                <button class="btn btn-outline btn-sm" onclick="loadUsers()">
                  <i class="fas fa-sync"></i> Yenile
                </button>
              </div>
              <table id="table-users">
                <thead>
                  <tr>
                    <th>Ad Soyad</th>
                    <th>E-Posta</th>
                    <th>Seviye / Puan</th>
                    <th>Sipari≈ü</th>
                    <th>Hak / Katƒ±lƒ±m</th>
                    <th>Son Giri≈ü / Seri</th>
                    <th>Davet</th>
                    <th>Doƒüum G√ºn√º</th>
                    <th>ƒ∞≈ülemler</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <div style="text-align: center; margin-top: 15px">
                <button
                  id="btnLoadMoreUsers"
                  class="btn btn-outline btn-sm"
                  onclick="loadUsers(true)"
                  style="display: none"
                >
                  ‚¨áÔ∏è Daha Fazla Y√ºkle
                </button>
              </div>
            </div>
          </div>

          <div id="page-productPool" class="page-section">
            <div class="card" style="margin-top: 0">
              <div
                class="table-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  width: 100%;
                "
              >
                <h5 style="margin: 0">Stok Kodu Havuzu</h5>
                <div style="display: flex; gap: 10px">
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="deleteAllProducts()"
                  >
                    <i class="fas fa-trash-alt"></i> T√ºm√ºn√º Sil
                  </button>
                  <button
                    class="btn btn-info btn-sm"
                    onclick="openModal('modalBulkProduct')"
                  >
                    <i class="fas fa-file-import"></i> Toplu Y√ºkle
                  </button>
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="openModal('modalProduct')"
                  >
                    <i class="fas fa-plus"></i> Tek Ekle
                  </button>
                </div>
              </div>
              <div
                style="
                  background: #e0f2fe;
                  padding: 15px;
                  border-radius: 8px;
                  color: #075985;
                  margin: 20px 0;
                  font-size: 0.9rem;
                "
              >
                <i class="fas fa-info-circle"></i> <b>Bilgi:</b> Buraya sadece
                √ºr√ºnlerin <b>Stok Kodlarƒ±nƒ± (SKU)</b> giriniz. Sistem her gece
                buradan rastgele 5 kod se√ßer ve "Sistem Verisi"ne g√∂nderir.
              </div>
              <table id="table-products">
                <thead>
                  <tr>
                    <th>Stok Kodu (SKU)</th>
                    <th>Eklenme Tarihi</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-raffles" class="page-section">
            <div class="card" style="margin-top: 0">
              <div
                class="table-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <h5>√áekili≈ü Listesi</h5>

                <div style="display: flex; gap: 10px">
                  <!-- üî• YENƒ∞ BUTON: OTO-Pƒ∞LOT -->
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="openAutoRaffleModal()"
                  >
                    <i class="fas fa-robot"></i> Oto-Pilot
                  </button>

                  <button
                    class="btn btn-success btn-sm"
                    onclick="forceOpenRaffleModal()"
                  >
                    <i class="fas fa-play"></i> Yeni √áekili≈ü Ba≈ülat
                  </button>
                </div>
              </div>
              <table id="table-raffles">
                <thead>
                  <tr>
                    <th>√áekili≈ü Adƒ±</th>
                    <th>Biti≈ü Tarihi</th>
                    <th>√ñd√ºl</th>
                    <th>Katƒ±lƒ±mcƒ± / Kazanan</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülemler</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-winners" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Kazananlar Listesi</h5>
                <button class="btn btn-outline btn-sm" onclick="loadWinners()">
                  Yenile
                </button>
              </div>
              <table id="table-winners" style="width: 100%; margin-top: 15px">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√áekili≈ü Adƒ±</th>
                    <th>Kazanan</th>
                    <th>√ñd√ºl</th>
                    <th>Sƒ±ra</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-couponPool" class="page-section">
            <div class="card" style="margin-top: 0">
              <div
                class="table-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  width: 100%;
                "
              >
                <h5 style="margin: 0">Kupon Havuzu</h5>
                <div style="display: flex; gap: 10px">
                  <button
                    class="btn btn-danger btn-sm"
                    onclick="deleteAllCoupons()"
                  >
                    <i class="fas fa-trash-alt"></i> T√ºm√ºn√º Sil
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="openModal('modalGenerateCoupon')"
                  >
                    <i class="fas fa-magic"></i> Otomatik √úret
                  </button>
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="openModal('modalCoupon')"
                  >
                    <i class="fas fa-plus"></i> Tek Ekle
                  </button>
                </div>
              </div>
              <table id="table-couponPool">
                <thead>
                  <tr>
                    <th>Kupon Kodu</th>
                    <th>ƒ∞ndirim</th>
                    <th>Son Kullanma</th>
                    <th>Faprika Onayƒ±</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-couponStore" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>Kupon Maƒüazasƒ± (S√ºr√ºkle-Bƒ±rak)</h5>

                <div style="display: flex; gap: 10px">
                  <button
                    class="btn btn-warning btn-sm"
                    onclick="saveStoreOrder()"
                  >
                    <i class="fas fa-save"></i> Sƒ±ralamayƒ± Kaydet
                  </button>

                  <button
                    class="btn btn-primary btn-sm"
                    onclick="openModal('modalStoreItem')"
                  >
                    <i class="fas fa-plus"></i> √úr√ºn Ekle
                  </button>
                </div>
              </div>

              <div
                style="
                  background: #fff7ed;
                  color: #c2410c;
                  padding: 10px;
                  font-size: 12px;
                  border-radius: 6px;
                  margin-bottom: 10px;
                "
              >
                <i class="fas fa-info-circle"></i> Satƒ±rlarƒ± tutup s√ºr√ºkleyerek
                sƒ±rasƒ±nƒ± deƒüi≈ütirebilirsiniz. Deƒüi≈üiklikten sonra "Sƒ±ralamayƒ±
                Kaydet"e basmayƒ± unutmayƒ±n.
              </div>

              <table id="table-couponStore">
                <thead>
                  <tr>
                    <th style="width: 30px">#</th>
                    <th>√úr√ºn Ba≈ülƒ±ƒüƒ±</th>
                    <th>Bedel (XP)</th>
                    <th>Stok</th>
                    <th>Tip</th>
                    <th>Seviye</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody id="store-sortable-list"></tbody>
              </table>
            </div>
          </div>

          <div id="page-tasks" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>G√∂rev Tanƒ±mlarƒ±</h5>
                <button
                  class="btn btn-primary btn-sm"
                  onclick="openNewTaskModal()"
                >
                  <i class="fas fa-plus"></i> G√∂rev Olu≈ütur
                </button>
              </div>
              <table id="table-tasks">
                <thead>
                  <tr>
                    <th style="width: 50px">ID</th>
                    <th>Ba≈ülƒ±k</th>
                    <th>Tip</th>
                    <th>Adƒ±m 1 Tipi</th>
                    <th>Adƒ±m 2 Tipi</th>
                    <th>√ñd√ºl (XP)</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-userProgress" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>Son Tamamlanan G√∂revler (Canlƒ± Akƒ±≈ü)</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadUserProgress()"
                >
                  Yenile
                </button>
              </div>
              <table id="table-userProgress">
                <thead>
                  <tr>
                    <th style="width: 130px">Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>G√∂rev ID</th>
                    <th>G√∂rev Adƒ±</th>
                    <th>ƒ∞lerleme Durumu</th>
                    <th>Sonu√ß</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-systemData" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>Bug√ºn√ºn Altƒ±n √úr√ºnleri (Otomatik Se√ßim)</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadDailyCodes()"
                >
                  Yenile
                </button>
              </div>
              <div
                id="daily-golden-codes"
                style="
                  display: flex;
                  gap: 10px;
                  flex-wrap: wrap;
                  margin-top: 15px;
                "
              ></div>
            </div>
            <div class="card">
              <div
                class="table-header"
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <h5 style="margin: 0">Efsane Havuzu (Legend Pool)</h5>
                <button
                  class="btn btn-success btn-sm"
                  onclick="manualAddPool()"
                >
                  <i class="fas fa-plus-circle"></i> Fon Ekle
                </button>
              </div>
              <div
                style="
                  font-size: 2rem;
                  font-weight: 800;
                  color: var(--warning);
                  margin-top: 10px;
                "
                id="legendPoolAmount"
              >
                Y√ºkleniyor...
              </div>
              <p style="color: #64748b">
                Efsane seviyesindeki √ºyelere daƒüƒ±tƒ±lacak birikmi≈ü tutar.
              </p>
            </div>
          </div>

          <div id="page-settings" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Sistem Parametreleri</h5>
                <button class="btn btn-primary btn-sm" onclick="saveSettings()">
                  Kaydet
                </button>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 20px;
                  margin-top: 15px;
                "
              >
                <div class="form-group">
                  <label>XP_KATILIM (√áekili≈ü Puanƒ±)</label
                  ><input type="number" id="set_xp_katilim" />
                </div>
                <div class="form-group">
                  <label>XP_GUNLUK (Buton Puanƒ±)</label
                  ><input type="number" id="set_xp_gunluk" />
                </div>
                <div class="form-group">
                  <label>XP_REFERANS (Davet Puanƒ±)</label
                  ><input type="number" id="set_xp_referans" />
                </div>
                <div class="form-group">
                  <label>XP_DOGUMTARIHI (Profil Dolumu)</label
                  ><input type="number" id="set_xp_dogumtarihi" />
                </div>
                <!-- YENƒ∞: HO≈ûGELDƒ∞N BONUSU AYARI -->
                <div class="form-group">
                  <label style="color: #8b5cf6; font-weight: bold"
                    >XP_HOSGELDIN (ƒ∞lk Giri≈ü)</label
                  >
                  <input
                    type="number"
                    id="set_xp_hosgeldin"
                    placeholder="50"
                    style="border-color: #8b5cf6"
                  />
                </div>
                <div
                  style="
                    border: 2px dashed #e11d48;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 15px;
                    background: rgba(225, 29, 72, 0.05);
                  "
                >
                  <h5 style="margin: 0 0 10px 0; color: #e11d48">
                    üéÇ Yƒ±llƒ±k Doƒüum G√ºn√º Hediyeleri (Robot)
                  </h5>

                  <div style="display: flex; gap: 15px">
                    <div class="form-group" style="flex: 1">
                      <label style="color: #e11d48; font-weight: bold"
                        >Hediye Puan (XP)</label
                      >
                      <input
                        type="number"
                        id="set_xp_yillik_dogumgunu"
                        placeholder="500"
                        style="border-color: #e11d48"
                      />
                    </div>

                    <div class="form-group" style="flex: 1">
                      <label style="color: #e11d48; font-weight: bold"
                        >Hediye Hak (Adet)</label
                      >
                      <input
                        type="number"
                        id="set_hak_yillik_dogumgunu"
                        placeholder="5"
                        style="border-color: #e11d48"
                      />
                    </div>
                  </div>
                  <small style="color: #666"
                    >M√º≈üterinin doƒüum g√ºn√ºnde her yƒ±l otomatik olarak hesabƒ±na
                    y√ºklenecek tutarlar.</small
                  >
                </div>

                <div class="form-group">
                  <label>LVL_USTA_MIN (Seviye 1)</label
                  ><input type="number" id="set_lvl_usta_min" />
                </div>
                <div class="form-group">
                  <label>LVL_SAMPIYON_MIN (Seviye 2)</label
                  ><input type="number" id="set_lvl_sampiyon_min" />
                </div>
                <div class="form-group">
                  <label>LVL_EFSANE_MIN (Seviye 3)</label
                  ><input type="number" id="set_lvl_efsane_min" />
                </div>
                <div class="form-group">
                  <label>Usta ƒ∞√ßin Min. Sipari≈ü</label>
                  <input
                    type="number"
                    id="set_order_min_usta"
                    placeholder="1"
                  />
                </div>
                <div class="form-group">
                  <label>≈ûampiyon ƒ∞√ßin Min. Sipari≈ü</label>
                  <input
                    type="number"
                    id="set_order_min_sampiyon"
                    placeholder="2"
                  />
                </div>
                <div class="form-group">
                  <label>Efsane ƒ∞√ßin Min. Sipari≈ü</label>
                  <input
                    type="number"
                    id="set_order_min_efsane"
                    placeholder="5"
                  />
                </div>
                <div class="form-group">
                  <label>MAX_IP_ISTEK (G√ºvenlik Sƒ±nƒ±rƒ±)</label
                  ><input type="number" id="set_max_ip_istek" />
                </div>

                <div class="form-group">
                  <label>Sipari≈ü XP (L1 - Standart)</label
                  ><input type="number" id="set_siparis_xp_l1" />
                </div>
                <div class="form-group">
                  <label>Sipari≈ü XP (L2 - Bronz)</label
                  ><input type="number" id="set_siparis_xp_l2" />
                </div>
                <div class="form-group">
                  <label>Sipari≈ü XP (L3 - G√ºm√º≈ü)</label
                  ><input type="number" id="set_siparis_xp_l3" />
                </div>
                <div class="form-group">
                  <label>Sipari≈ü XP (L4 - Altƒ±n)</label
                  ><input type="number" id="set_siparis_xp_l4" />
                </div>

                <div class="form-group">
                  <label>Limit L2 (Bronz TL)</label
                  ><input type="number" id="set_siparis_limit_l2" />
                </div>
                <div class="form-group">
                  <label>Limit L3 (G√ºm√º≈ü TL)</label
                  ><input type="number" id="set_siparis_limit_l3" />
                </div>
                <div class="form-group">
                  <label>Limit L4 (Altƒ±n TL)</label
                  ><input type="number" id="set_siparis_limit_l4" />
                </div>

                <div class="form-group">
                  <label style="color: #e67e22"
                    >üì∏ G√ºn√ºn/Haftanƒ±n ≈ûifresi (Instagram)</label
                  >
                  <div style="display: flex; gap: 10px">
                    <input
                      type="text"
                      id="set_daily_secret_code"
                      placeholder="Manuel Tek ≈ûifre"
                      style="border: 2px solid #e67e22"
                    />
                    <button
                      class="btn btn-warning btn-sm"
                      onclick="openModal('modalScheduleCodes')"
                    >
                      <i class="fas fa-calendar-alt"></i> Planla
                    </button>
                  </div>
                  <small style="color: #666"
                    >"Planla" ile ileri tarihli ≈üifreler girebilirsin. Takvimde
                    o g√ºn bo≈üsa buradaki tek ≈üifre ge√ßerli olur.</small
                  >
                </div>
              </div>
            </div>

            <div class="card" style="margin-top: 25px">
              <div class="table-header">
                <h5 style="margin: 0">üìÖ Planlanmƒ±≈ü ≈ûifre Takvimi</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadScheduledCodes()"
                >
                  <i class="fas fa-sync"></i> Yenile
                </button>
              </div>
              <div
                style="max-height: 300px; overflow-y: auto; margin-top: 15px"
              >
                <table id="table-scheduledCodes" style="width: 100%">
                  <thead>
                    <tr>
                      <th>Tarih</th>
                      <th>≈ûifre</th>
                      <th>Durum</th>
                      <th>ƒ∞≈ülem</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="page-securityLogs" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>Y√∂netici ƒ∞≈ülem Kayƒ±tlarƒ±</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadSecurityLogs()"
                >
                  Yenile
                </button>
              </div>
              <table id="table-securityLogs">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>ƒ∞≈ülem Tipi</th>
                    <th>Detay</th>
                    <th>IP</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-systemLogs" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5>Kullanƒ±cƒ± Hareketleri (Tƒ±klama Ge√ßmi≈üi)</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadSystemLogs()"
                >
                  Yenile
                </button>
              </div>
              <table id="table-systemLogs">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>Eylem</th>
                    <th>Detay</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div id="page-referrals" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Referans Hareketleri (Son 50)</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadReferrals()"
                >
                  Yenile
                </button>
              </div>
              <table id="table-referrals" style="width: 100%; margin-top: 15px">
                <thead>
                  <tr>
                    <th>Davet Eden</th>
                    <th>Yeni √úye</th>
                    <th>Tarih</th>
                    <th>Kazan√ß</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="page-pointHistory" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Puan Hareketleri</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadPointHistory()"
                >
                  Yenile
                </button>
              </div>
              <table
                id="table-pointHistory"
                style="width: 100%; margin-top: 15px"
              >
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>ƒ∞≈ülem</th>
                    <th>Puan/Hak</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="page-participants" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Aktif √áekili≈ü Biletleri (Canlƒ±)</h5>
                <div style="display: flex; gap: 5px; margin-left: auto">
                  <input
                    type="text"
                    id="partSearchInput"
                    placeholder="E-posta ara..."
                    style="
                      padding: 5px 10px;
                      border: 1px solid #cbd5e1;
                      border-radius: 6px;
                      font-size: 12px;
                      width: 200px;
                    "
                  />
                  <button
                    class="btn btn-primary btn-sm"
                    onclick="searchParticipants()"
                  >
                    Ara
                  </button>
                  <button
                    class="btn btn-outline btn-sm"
                    onclick="clearPartSearch()"
                  >
                    Sil
                  </button>
                </div>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadParticipants()"
                >
                  Yenile
                </button>
              </div>
              <table
                id="table-participants"
                style="width: 100%; margin-top: 15px"
              >
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√áekili≈ü Adƒ±</th>
                    <th>M√º≈üteri</th>
                    <th>Bilet ID</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="page-archive" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Ar≈üivlenmi≈ü √áekili≈ü Kayƒ±tlarƒ±</h5>
                <button class="btn btn-outline btn-sm" onclick="loadArchive()">
                  Yenile
                </button>
              </div>
              <table id="table-archive" style="width: 100%; margin-top: 15px">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>√áekili≈ü</th>
                    <th>Kullanƒ±cƒ±</th>
                    <th>Bilet ID</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="page-feedback" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Destek Talepleri (Ticket)</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadFeedbacks()"
                >
                  Yenile
                </button>
              </div>
              <table id="table-feedback" style="width: 100%; margin-top: 15px">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>M√º≈üteri</th>
                    <th>Konu / Mesaj</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülem</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div id="page-notifications" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">
                  Haber Listesi Abone: <span id="sub-count">0</span>
                </h5>
                <div style="display: flex; gap: 10px">
                  <button
                    class="btn btn-info btn-sm"
                    onclick="openModal('modalAnnouncement')"
                  >
                    <i class="fas fa-bullhorn"></i> Duyuru Yap
                  </button>
                  <button
                    class="btn btn-outline btn-sm"
                    onclick="loadNotifications()"
                  >
                    Yenile
                  </button>
                </div>
              </div>
              <div
                style="max-height: 400px; overflow-y: auto; margin-top: 15px"
              >
                <table id="table-notifications" style="width: 100%">
                  <thead>
                    <tr>
                      <th>Kayƒ±t Tarihi</th>
                      <th>E-Posta Adresi</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="page-logger" class="page-section">
            <div class="card" style="margin-top: 0">
              <div class="table-header">
                <h5 style="margin: 0">Hata Kayƒ±tlarƒ±</h5>
                <button
                  class="btn btn-outline btn-sm"
                  onclick="loadErrorLogs()"
                >
                  <i class="fas fa-sync"></i> Yenile
                </button>
              </div>
              <table id="table-logger" style="width: 100%; margin-top: 15px">
                <thead>
                  <tr>
                    <th>Tarih</th>
                    <th>Hata Mesajƒ±</th>
                    <th>Detay</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- MODAL: YENƒ∞ SKU EKLE -->
    <div id="modalProduct" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Yeni Stok Kodu (SKU)</h3>
          <span
            onclick="closeModal('modalProduct')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>Stok Kodu (Faprika'daki ile aynƒ± olmalƒ±)</label>
          <input type="text" id="inputNewSku" placeholder="√ñrn: TSHIRT-BLK-S" />
        </div>
        <button class="btn btn-primary" style="width: 100%" onclick="addSku()">
          Kaydet
        </button>
      </div>
    </div>
    <div id="modalBulkProduct" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Toplu SKU Y√ºkle</h3>
          <span
            onclick="closeModal('modalBulkProduct')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>Stok Kodlarƒ± (Her satƒ±ra bir tane veya virg√ºlle ayƒ±rƒ±n)</label>
          <textarea
            id="inputBulkSkus"
            rows="10"
            placeholder="TSHIRT-001&#10;TSHIRT-002&#10;KAZAK-KRM-M, KAZAK-KRM-L"
          ></textarea>
        </div>
        <button
          class="btn btn-primary"
          style="width: 100%"
          onclick="addBulkSkus()"
        >
          Y√ºkle ve Kaydet
        </button>
      </div>
    </div>

    <!-- MODAL: PUAN VER -->
    <div id="modalGivePoint" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Puan Ver / Sil</h3>
          <span
            onclick="closeModal('modalGivePoint')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>Kullanƒ±cƒ± E-Posta</label
          ><input
            type="text"
            id="inputPointEmail"
            placeholder="ornek@musteri.com"
          />
        </div>
        <div class="form-group">
          <label>ƒ∞≈ülem</label
          ><select id="selectPointAction">
            <option value="add">Puan Ekle (+)</option>
            <option value="remove">Puan Sil (-)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Miktar</label
          ><input type="number" id="inputPointAmount" placeholder="100" />
        </div>
        <button
          class="btn btn-primary"
          style="width: 100%"
          onclick="submitPointAction()"
        >
          ƒ∞≈ülemi Uygula
        </button>
      </div>
    </div>

    <!-- MODAL: YENƒ∞ G√ñREV EKLE (G√úNCELLENMƒ∞≈û) -->
    <div id="modalTask" class="modal">
      <div class="modal-content" style="width: 600px">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Yeni G√∂rev Olu≈ütur</h3>
          <span
            onclick="closeModal('modalTask')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>

        <!-- 1. SIKLIK VE ID -->
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
          "
        >
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label>Sƒ±klƒ±k (Tekrar Durumu)</label>
                <select
                  name="frequency"
                  id="task_frequency"
                  class="form-control"
                >
                  <option value="TEK">Tek Seferlik</option>
                  <option value="GUNLUK">G√ºnl√ºk (Her Gece Sƒ±fƒ±rlanƒ±r)</option>
                  <option value="HAFTALIK">
                    Haftalƒ±k (Her Hafta Sƒ±fƒ±rlanƒ±r)
                  </option>
                </select>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>√ñzel G√∂rev ID (Opsiyonel)</label>
                <input
                  type="text"
                  name="custom_task_id"
                  id="custom_task_id"
                  class="form-control"
                  placeholder="√ñrn: gunluk_rutin_v1"
                />
                <small class="form-text text-muted"
                  >Bo≈ü bƒ±rakƒ±rsan sistem otomatik √ºretir.</small
                >
              </div>
            </div>
          </div>

          <!-- 2. BA≈ûLIK VE A√áIKLAMA -->
          <div class="form-group">
            <label>G√∂rev Ba≈ülƒ±ƒüƒ±</label>
            <input
              type="text"
              id="taskTitle"
              placeholder="√ñrn: G√ºn√ºn ≈ûifresini Bul"
            />
          </div>

          <div class="form-group">
            <label>A√ßƒ±klama</label>
            <textarea
              id="taskDesc"
              rows="2"
              placeholder="G√∂rev detaylarƒ±..."
            ></textarea>
          </div>

          <!-- 3. √ñD√úLLER -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-bottom: 15px;
            "
          >
            <div class="form-group">
              <label>B√ºy√ºk √ñd√ºl (XP)</label>
              <input type="number" id="taskReward" value="50" />
            </div>
            <div class="form-group">
              <label>B√ºy√ºk √ñd√ºl (Hak)</label>
              <input type="number" id="taskRewardRights" value="0" />
            </div>
          </div>

          <!-- 4. ADIMLAR (ƒ∞≈ûLEM Tƒ∞Pƒ∞ BURADA SE√áƒ∞Lƒ∞R) -->
          <div
            style="
              background: #f8fafc;
              padding: 15px;
              border-radius: 8px;
              border: 1px solid #e2e8f0;
            "
          >
            <h5
              style="
                margin: 0 0 10px 0;
                color: #333;
                border-bottom: 1px solid #ddd;
                padding-bottom: 5px;
              "
            >
              üë£ G√∂rev Adƒ±mlarƒ± (Aksiyonlar)
            </h5>

            <!-- 1. ADIM -->
            <div style="margin-bottom: 15px">
              <label style="font-size: 0.8rem; font-weight: bold"
                >1. Adƒ±m:</label
              >
              <div style="display: flex; gap: 10px">
                <select id="step1Type" style="flex: 1">
                  <option value="">ƒ∞≈ülem Se√ß...</option>
                  <option value="instagram">Instagram (Takip/Beƒüeni)</option>
                  <option value="visit">Site/Link Ziyareti</option>
                  <option value="sifre_gir">≈ûifre Gir (Kod)</option>
                  <option value="sepete_ekle">Sepete Ekle</option>
                  <option value="urun_gez">√úr√ºn Gez</option>
                  <option value="yorum_yap">Yorum Yap</option>
                </select>
                <input
                  type="text"
                  id="step1Desc"
                  placeholder="Adƒ±m A√ßƒ±klamasƒ± (√ñrn: Hikayeye Bak)"
                  style="flex: 2"
                />
                <input
                  type="number"
                  id="step1Target"
                  value="1"
                  placeholder="Hedef"
                  style="width: 60px"
                />
              </div>
              <!-- Link Kutusu (Sadece Link Gerektirenler ƒ∞√ßin) -->
              <input
                type="text"
                id="step1Link"
                placeholder="Varsa Link (https://...)"
                style="
                  width: 100%;
                  margin-top: 5px;
                  font-size: 0.85rem;
                  color: #666;
                "
              />
            </div>

            <!-- 2. ADIM -->
            <div>
              <label style="font-size: 0.8rem; font-weight: bold"
                >2. Adƒ±m (Opsiyonel):</label
              >
              <div style="display: flex; gap: 10px">
                <select id="step2Type" style="flex: 1">
                  <option value="">Yok</option>
                  <option value="sifre_gir">≈ûifre Gir (Kod)</option>
                  <option value="instagram">Instagram</option>
                  <option value="visit">Link Ziyareti</option>
                </select>
                <input
                  type="text"
                  id="step2Desc"
                  placeholder="Adƒ±m A√ßƒ±klamasƒ±"
                  style="flex: 2"
                />
              </div>
            </div>
          </div>

          <button
            class="btn btn-primary"
            style="width: 100%; margin-top: 20px"
            onclick="submitNewTask()"
          >
            Kaydet ve Olu≈ütur
          </button>
        </div>
      </div>
    </div>
    <div id="modalCreateSurvey" class="modal">
      <div class="modal-content">
        <h3>Yeni Anket Olu≈ütur</h3>
        <div class="form-group">
          <label>Soru</label>
          <input
            type="text"
            id="surveyQuestion"
            placeholder="√ñrn: Sitemizi nasƒ±l buldunuz?"
          />
        </div>
        <div class="form-group">
          <label>≈ûƒ±klar (Virg√ºlle ayƒ±rƒ±n)</label>
          <input
            type="text"
            id="surveyOptions"
            placeholder="√ñrn: Harika, ƒ∞yi, K√∂t√º"
          />
        </div>
        <div class="form-group">
          <label>√ñd√ºl (XP)</label>
          <input type="number" id="surveyReward" value="50" />
        </div>
        <button
          class="btn btn-success"
          style="width: 100%"
          onclick="createSurvey()"
        >
          Yayƒ±nla
        </button>
        <button
          class="btn btn-outline"
          style="width: 100%; margin-top: 10px"
          onclick="closeModal('modalCreateSurvey')"
        >
          ƒ∞ptal
        </button>
      </div>
    </div>
    <div id="modalGenerateCoupon" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">‚ú® Otomatik Kupon Fabrikasƒ±</h3>
          <span
            onclick="closeModal('modalGenerateCoupon')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>Ka√ß Adet?</label
          ><input type="number" id="genCount" value="10" />
        </div>
        <div class="form-group">
          <label>√ñn Ek (Prefix)</label
          ><input
            type="text"
            id="genPrefix"
            placeholder="√ñrn: YAZ2025 (Bo≈ü bƒ±rakƒ±labilir)"
          />
        </div>
        <div class="form-group">
          <label>ƒ∞ndirim Deƒüeri</label
          ><input type="number" id="genDisc" placeholder="100" />
        </div>
        <div class="form-group">
          <label>ƒ∞ndirim Tipi</label
          ><select id="genType">
            <option value="tl">TL ƒ∞ndirim</option>
            <option value="percent">Y√ºzde (%)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Son Kullanma</label><input type="date" id="genExpiry" />
        </div>

        <button
          class="btn btn-warning"
          style="width: 100%"
          onclick="generateCoupons()"
        >
          üöÄ Kodlarƒ± √úret ve Kaydet
        </button>
      </div>
    </div>
    <div id="modalStoreItem" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Maƒüaza √úr√ºn√º Olu≈ütur</h3>
          <span
            onclick="closeModal('modalStoreItem')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>√úr√ºn Ba≈ülƒ±ƒüƒ±</label
          ><input
            type="text"
            id="stTitle"
            placeholder="√ñrn: 50 TL ƒ∞ndirim √áeki"
          />
        </div>
        <div class="form-group">
          <label>A√ßƒ±klama</label
          ><input type="text" id="stDesc" placeholder="Kƒ±sa a√ßƒ±klama..." />
        </div>
        <div class="form-group">
          <label>Puan Bedeli (XP)</label
          ><input type="number" id="stCost" placeholder="2500" />
        </div>
        <div class="form-group">
          <label>Stok Adedi</label
          ><input type="number" id="stStock" value="100" />
        </div>
        <div class="form-group">
          <label>Tip</label
          ><select id="stType">
            <option value="coupon_code">Dijital Kupon</option>
            <option value="physical_gift">Fiziksel Hediye</option>
            <option value="hak_paketi">√áekili≈ü Hakkƒ±</option>
          </select>
        </div>
        <div class="form-group">
          <label style="color: #e67e22; font-weight: bold"
            >Tanƒ±mlƒ± Kupon Kodu (√áer√ßeve Adƒ±)</label
          >
          <input
            type="text"
            id="stKuponKodu"
            placeholder="√ñrn: frame-neon (Normal kuponsa bo≈ü bƒ±rak)"
          />
          <small style="color: #666; font-size: 11px"
            >√áer√ßeveler i√ßin CSS adƒ±nƒ± buraya yaz.</small
          >
        </div>
        <div class="form-group">
          <label>Gerekli Seviye (Kimler Alabilir?)</label>
          <select
            id="stLevel"
            style="border: 2px solid #8b5cf6; color: #8b5cf6; font-weight: bold"
          >
            <option value="√áaylak">üü¢ Herkes (√áaylak ve √úzeri)</option>
            <option value="Usta">üü£ Sadece Ustalar ve √úzeri</option>
            <option value="≈ûampiyon">üü† Sadece ≈ûampiyonlar ve √úzeri</option>
            <option value="Efsane">üî¥ Sadece Efsaneler</option>
          </select>
        </div>
        <button
          class="btn btn-primary"
          style="width: 100%"
          onclick="addStoreItem()"
        >
          √úr√ºn√º Olu≈ütur
        </button>
      </div>
    </div>
    <div id="modalReply" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">Talebi Cevapla</h3>
          <span
            onclick="closeModal('modalReply')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <input type="hidden" id="replyDocId" />
        <div class="form-group">
          <label>Konu:</label><input type="text" id="replySubject" disabled />
        </div>
        <div class="form-group">
          <label>M√º≈üteri Mesajƒ±:</label
          ><textarea id="replyUserMsg" rows="3" disabled></textarea>
        </div>
        <div class="form-group">
          <label>Cevabƒ±nƒ±z:</label
          ><textarea
            id="replyAdminMsg"
            rows="4"
            placeholder="Yanƒ±tƒ±nƒ±zƒ± buraya yazƒ±n..."
          ></textarea>
        </div>
        <button
          class="btn btn-primary"
          style="width: 100%"
          onclick="sendReply()"
        >
          Yanƒ±tƒ± G√∂nder
        </button>
      </div>
    </div>

    <div id="modalAnnouncement" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">üì¢ Toplu Duyuru G√∂nder</h3>
          <span
            onclick="closeModal('modalAnnouncement')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>
        <div class="form-group">
          <label>Konu Ba≈ülƒ±ƒüƒ±</label
          ><input
            type="text"
            id="annSubject"
            placeholder="√ñrn: B√ºy√ºk √áekili≈ü Ba≈üladƒ±!"
          />
        </div>
        <div class="form-group">
          <label>Mesaj ƒ∞√ßeriƒüi</label
          ><textarea
            id="annContent"
            rows="5"
            placeholder="Duyuru detaylarƒ±..."
          ></textarea>
        </div>
        <button
          class="btn btn-info"
          style="width: 100%"
          onclick="sendAnnouncement()"
        >
          üöÄ Herkese G√∂nder
        </button>
      </div>
    </div>

    <div id="modalScheduleCodes" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">üìÖ Haftalƒ±k/Aylƒ±k ≈ûifre Planla</h3>
          <span
            onclick="closeModal('modalScheduleCodes')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>

        <div class="form-group">
          <label>Ba≈ülangƒ±√ß Tarihi</label>
          <input type="date" id="schStartDate" />
        </div>

        <div class="form-group">
          <label>≈ûifre Listesi (Her satƒ±ra bir tane)</label>
          <textarea
            id="schCodes"
            rows="10"
            placeholder="PAZARTESI100&#10;SALI200&#10;CARSAMBA300&#10;..."
          ></textarea>
          <small style="color: #666"
            >√ñrn: 7 satƒ±r yazarsan, se√ßtiƒüin tarihten itibaren 7 g√ºn boyunca
            sƒ±rasƒ±yla bunlar ge√ßerli olur.</small
          >
        </div>

        <button
          class="btn btn-success"
          style="width: 100%"
          onclick="scheduleCodes()"
        >
          üíæ Takvimi Kaydet
        </button>
      </div>
    </div>

    <script>
      function escapeHtml(text) {
        if (!text) return ""; // Veri yoksa bo≈ü d√∂n
        return text
          .toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
      let globalTaskList = []; // Verileri burada tutacaƒüƒ±z
      // üß† AKILLI HAFIZA FONKSƒ∞YONU (CACHE MANAGER)
      async function smartFetch(islem, cacheKey, durationMinutes = 5) {
        // 1. √ñnce hafƒ±zaya bak
        const cached = localStorage.getItem("cache_" + cacheKey);
        if (cached) {
          const data = JSON.parse(cached);
          const now = Date.now();
          // S√ºresi dolmamƒ±≈üsa (√ñrn: 5 dakika) direkt hafƒ±zadan ver
          if (now - data.timestamp < durationMinutes * 60 * 1000) {
            console.log(`‚ö° ${cacheKey} hafƒ±zadan y√ºklendi (Hƒ±zlƒ± & Bedava)`);
            return { ...data.payload, fromCache: true };
          }
        }

        // 2. Hafƒ±zada yoksa veya s√ºresi dolduysa sunucudan √ßek
        console.log(`üåê ${cacheKey} sunucudan √ßekiliyor...`);
        const res = await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: islem }),
        });
        const result = await res.json();

        // 3. Ba≈üarƒ±lƒ±ysa hafƒ±zaya at (Tarih damgasƒ±yla)
        if (result.success) {
          localStorage.setItem(
            "cache_" + cacheKey,
            JSON.stringify({
              timestamp: Date.now(),
              payload: result,
            })
          );
        }
        return result;
      }

      // üî• √ñNEMLƒ∞: Manuel yenileme yapƒ±lƒ±rsa hafƒ±zayƒ± temizle
      function clearCache(key) {
        localStorage.removeItem("cache_" + key);
      }
      let editingTaskId = null; // D√ºzenlenen g√∂revin ID'si
      // üáπüá∑ T√úRKƒ∞YE SAATƒ∞ D√úZELTƒ∞Cƒ∞ (G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON)
      function formatTrDate(val) {
        if (!val) return "-";

        let dateObj;

        // 1. Durum: Firebase Timestamp (_seconds var)
        if (val && val._seconds) {
          dateObj = new Date(val._seconds * 1000);
        }
        // 2. Durum: Zaten Date objesi
        else if (val instanceof Date) {
          dateObj = val;
        }
        // 3. Durum: Metin (String) Gelirse (√ñrn: "2025-12-14 21:06")
        else {
          let s = String(val).trim();

          // Eƒüer "14.12.2025" gibi noktalƒ± geldiyse, JS anlamaz. Ters √ßevirelim.
          if (s.includes(".") && s.split(".").length === 3 && s.length < 20) {
            // Basit √ßeviri: 14.12.2025 21:06 -> 2025-12-14T21:06
            // Ama √ßok karma≈üƒ±kla≈ümasƒ±n, direkt UTC varsayalƒ±m:
            s = s.split(".").reverse().join("-");
          }

          // String'in sonunda "Z" veya "UTC" yoksa, biz ekleyelim ki tarayƒ±cƒ± bunun UTC olduƒüunu anlasƒ±n.
          if (
            !s.includes("Z") &&
            !s.includes("UTC") &&
            !s.includes("GMT") &&
            !s.includes("+03")
          ) {
            s += " UTC";
          }

          dateObj = new Date(s);
        }

        // Ge√ßersiz tarih kontrol√º
        if (isNaN(dateObj.getTime())) return String(val); // √áeviremezsen olduƒüu gibi g√∂ster

        // üî• Sƒ∞Hƒ∞R BURADA: Tarayƒ±cƒ±ya zorla "Europe/Istanbul" saatini kullandƒ±rƒ±yoruz
        return dateObj.toLocaleString("tr-TR", {
          timeZone: "Europe/Istanbul",
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
      // ... (Burada mevcut JavaScript kodlarƒ±n var) ...
      // API URL
      function getApiUrl() {
        return document.getElementById("apiUrlInput").value;
      }

      // NAVIGATION
      function showPage(pageId, title, desc) {
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));
        // Eƒüer sidebar linkinden tƒ±klandƒ±ysa active yap, dashboard i√ßinden tƒ±klandƒ±ysa manuel bulmaya √ßalƒ±≈üma (basit tutalƒ±m)
        const navLink = document.querySelector(`a[onclick*="'${pageId}'"]`);
        if (navLink) navLink.classList.add("active");

        document
          .querySelectorAll(".page-section")
          .forEach((el) => el.classList.remove("active"));
        const target = document.getElementById("page-" + pageId);
        if (target) target.classList.add("active");

        document.getElementById("header-title").innerText = title;
        document.getElementById("header-desc").innerText = desc;

        // Load Data
        if (pageId === "users") loadUsers();
        if (pageId === "productPool") loadProducts();
        if (pageId === "systemData") loadDailyCodes();
        if (pageId === "systemLogs") loadSystemLogs();
        if (pageId === "dashboard") loadDashboard();
        if (pageId === "settings") {
          loadSettings();
          loadScheduledCodes();
        }
        if (pageId === "securityLogs") loadSecurityLogs();
        if (pageId === "tasks") loadTasks();
        if (pageId === "raffles") loadRaffles();
        if (pageId === "winners") loadWinners();
        if (pageId === "participants") loadParticipants();
        if (pageId === "referrals") loadReferrals();
        if (pageId === "feedback") loadFeedbacks();
        if (pageId === "notifications") loadNotifications();
        if (pageId === "pointHistory") loadPointHistory();
        if (pageId === "archive") loadArchive();
        if (pageId === "logger") loadErrorLogs();
        if (pageId === "couponStore") loadCouponStore();
        if (pageId === "couponPool") loadCouponPool();
        if (pageId === "userProgress") loadUserProgress();
        if (pageId === "surveys") loadSurveys();
      }

      function openModal(id) {
        document.getElementById(id).classList.add("show");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("show");
      }
      async function loadPointHistory() {
        const tbody = document.querySelector("#table-pointHistory tbody");
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; padding:20px; color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Ge√ßmi≈ü Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_global_point_history" }),
          });
          const data = await res.json();

          if (data.success) {
            tbody.innerHTML = "";

            if (!data.list || data.list.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="4" style="text-align:center;">Hi√ß kayƒ±t yok.</td></tr>';
              return;
            }

            data.list.sort((a, b) => {
              // Bu fonksiyon her t√ºrl√º tarihi saniyeye √ßevirir
              const parseTime = (val) => {
                if (!val) return 0;

                // 1. Zaten sƒ±ralama deƒüeri varsa onu kullan (Backend'den geliyorsa)
                if (val.sortDate) return val.sortDate;
                if (a._sortScore) return a._sortScore;

                // 2. Veri alanƒ±nƒ± se√ß (date, tarih, createdAt)
                let raw = val.date || val.tarih || val.createdAt;

                // 3. Eƒüer zaten sayƒ±ysa (Timestamp)
                if (typeof raw === "number") return raw;

                // 4. Metin ise (String)
                let s = String(raw);

                // A) "December 22, 2025 at 3:30:16 AM UTC+3" formatƒ± (Screenshot 35'teki gibi)
                if (s.includes(" at ")) {
                  // "at" ve "UTC" kelimelerini temizle ki okunabilsin
                  s = s.replace(" at ", " ").replace("UTC+3", "").trim();
                }

                // B) "22.12.2025 14:00" formatƒ± (T√ºrk√ße)
                if (s.includes(".")) {
                  let parts = s.split(" ");
                  let dParts = parts[0].split(".");
                  // Yƒ±l-Ay-G√ºn formatƒ±na √ßevir: 2025-12-22
                  if (dParts.length === 3) {
                    let time = parts[1] || "00:00:00";
                    s = `${dParts[2]}-${dParts[1]}-${dParts[0]}T${time}`;
                  }
                }

                // Tarihi sayƒ±ya √ßevir
                let timeVal = new Date(s).getTime();
                return isNaN(timeVal) ? 0 : timeVal;
              };

              // B (Yeni) - A (Eski) i≈ülemi yaparak en yeniyi en √ºste alƒ±rƒ±z
              return parseTime(b) - parseTime(a);
            });

            data.list.forEach((item) => {
              // Puan Rengi
              let puanVal = parseInt(item.puan);
              let puanHtml = "";

              if (puanVal > 0) {
                puanHtml = `<span style="color:#10b981; font-weight:bold;">+${puanVal} XP</span>`;
              } else if (puanVal < 0) {
                puanHtml = `<span style="color:#ef4444; font-weight:bold;">${puanVal} XP</span>`;
              } else {
                puanHtml = `<span style="color:#94a3b8;">-</span>`;
              }

              // Hak G√∂sterimi
              if (item.hak && item.hak !== 0) {
                puanHtml += ` <span class="badge badge-warning" style="margin-left:5px;">${item.hak} Hak</span>`;
              }

              // Tarih ve E-posta stili
              tbody.innerHTML += `
                    <tr>
                        <td style="white-space:nowrap; font-size:0.85rem; color:#334155; font-family:monospace; font-weight:bold;">${item.date}</td>
                        <td><b>${item.email}</b></td>
                        <td style="font-size:0.9rem;">${item.islem}</td>
                        <td>${puanHtml}</td>
                    </tr>
                `;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="4" style="color:red; text-align:center;">Hata: ' +
              data.message +
              "</td></tr>";
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="4" style="color:red; text-align:center;">Baƒülantƒ± Hatasƒ±</td></tr>';
        }
      }

      async function loadArchive() {
        const tbody = document.querySelector("#table-archive tbody");
        tbody.innerHTML = '<tr><td colspan="4">Y√ºkleniyor...</td></tr>';
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_archived_entries" }),
          });
          const data = await res.json();
          if (data.success) {
            tbody.innerHTML = "";
            data.list.forEach((item) => {
              tbody.innerHTML += `<tr>
<td>${item.date}</td>
<td>${item.raffleName}</td>
<td>${item.email}</td>
<td><span class="badge badge-dark">${item.ticketId}</span></td>
          </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="4">Ar≈üiv bo≈ü.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="4">Hata.</td></tr>';
        }
      }

      // TAB DEƒûƒ∞≈ûTƒ∞RME
      function openTab(tabId) {
        // Butonlarƒ± resetle
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        // ƒ∞√ßerikleri gizle/g√∂ster
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
      }

      // DASHBOARD VERƒ∞ Y√úKLEME (G√úNCELLENMƒ∞≈û)
      async function loadDashboard() {
        // Butonu bulup d√∂nd√ºrelim (G√∂rsel Efekt)
        const refreshBtn = document.querySelector(
          "#page-dashboard .btn-outline i"
        );
        if (refreshBtn) refreshBtn.classList.add("fa-spin");

        try {
          // 1. CANLI ƒ∞STATƒ∞STƒ∞KLER
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_dashboard_stats" }),
          });
          const data = await res.json();

          if (data.success) {
            const s = data.stats;
            document.getElementById("d-goruntulenme").innerText =
              s.goruntulenme;
            document.getElementById("d-aktifuye").innerText = s.aktifUye;
            document.getElementById("d-dagitilanxp").innerText =
              s.dagitilanXP.toLocaleString();
            document.getElementById("d-verilenhak").innerText = s.verilenHak;

            document.getElementById("d-cekilis").innerText = s.cekilisKatilim;
            document.getElementById("d-magaza").innerText = s.magazaSatisi;
            document.getElementById("d-kutu").innerText = s.sansKutusu;
            document.getElementById("d-gorev").innerText = s.tamamlananGorev;
            document.getElementById("d-hazine").innerText = s.gizliHazine;
            document.getElementById("d-dogum").innerText = s.dogumGunu;
          }

          // 2. Y√ñNETƒ∞Cƒ∞ NOTLARI
          const resNotes = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_admin_notes" }),
          });
          const dataNotes = await resNotes.json();

          if (dataNotes.success && dataNotes.notes) {
            const n = dataNotes.notes;
            if (n.daily) {
              for (let k in n.daily) {
                const el = document.getElementById(`task-d-${k}`);
                if (el) el.checked = n.daily[k];
              }
            }
            if (n.weekly) {
              for (let k in n.weekly) {
                const el = document.getElementById(`task-w-${k}`);
                if (el) el.checked = n.weekly[k];
              }
            }
            if (n.monthly) {
              for (let k in n.monthly) {
                const el = document.getElementById(`task-m-${k}`);
                if (el) el.checked = n.monthly[k];
              }
            }
          }
        } catch (e) {
          console.error("Dashboard error:", e);
        } finally {
          // ƒ∞≈ülem bitince d√∂nmeyi durdur
          if (refreshBtn) refreshBtn.classList.remove("fa-spin");
        }
      }

      // NOT DURUMUNU KAYDETME
      async function toggleNote(type, id) {
        const checkbox = document.getElementById(
          `task-${type.charAt(0)}-${id}`
        );
        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            islem: "toggle_admin_note",
            type: type,
            id: id,
            status: checkbox.checked,
          }),
        });
      } // --- #4 KULLANICILAR (SAYFALAMA √ñZELLƒ∞KLƒ∞ v2) ---
      let lastUserCursor = null; // Nerede kaldƒ±ƒüƒ±mƒ±zƒ± tutan deƒüi≈üken

      async function loadUsers(isLoadMore = false, searchQuery = null) {
        const tbody = document.querySelector("#table-users tbody");
        const btnMore = document.getElementById("btnLoadMoreUsers");

        // Eƒüer "Yenile"ye basƒ±ldƒ±ysa her ≈üeyi sƒ±fƒ±rla
        if (!isLoadMore) {
          lastUserCursor = null;
          tbody.innerHTML =
            '<tr><td colspan="9" style="text-align:center;">Y√ºkleniyor...</td></tr>';
          if (btnMore) btnMore.style.display = "none";
          fetchApi("get_dashboard_stats").then((res) => {
            if (res.success && res.stats) {
              // Toplam √úye Sayƒ±sƒ±
              const totalUye = res.stats.aktifUye || 0;
              document.getElementById("stat-total-users").innerText = totalUye;

              // Toplam Puan (Hazƒ±r el deƒümi≈üken bunu da yazalƒ±m)
              const totalXP = res.stats.dagitilanXP || 0;
              document.getElementById("stat-total-xp").innerText =
                totalXP.toLocaleString() + " XP";
            }
          });
        } else {
          if (btnMore) btnMore.innerText = "Y√ºkleniyor...";
        }
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "getKullaniciListesi",
              lastVisibleId: lastUserCursor, // Kaldƒ±ƒüƒ±mƒ±z yeri g√∂nderiyoruz
              searchQuery: searchQuery,
            }),
          });
          const data = await res.json();

          if (data.success) {
            // Eƒüer ilk y√ºklemeyse "Y√ºkleniyor" yazƒ±sƒ±nƒ± sil
            if (!isLoadMore) tbody.innerHTML = "";

            if (data.users.length === 0) {
              if (!isLoadMore)
                tbody.innerHTML =
                  '<tr><td colspan="9" style="text-align:center;">Kayƒ±t bulunamadƒ±.</td></tr>';
              if (btnMore) btnMore.style.display = "none";
              return;
            }

            // Gelen kullanƒ±cƒ±larƒ± tabloya ekle
            data.users.forEach((u) => {
              let lvlBadge = "badge-info";
              if (u.seviye === "Usta") lvlBadge = "badge-success";
              if (u.seviye === "≈ûampiyon") lvlBadge = "badge-warning";
              if (u.seviye === "Efsane") lvlBadge = "bg-purple-light";

              const hak = u.hak || 0;
              const katilim = u.katilimSayisi || 0;
              const seriNo = u.gunlukSeri || 0;

              // Tarih d√ºzeltme
              let sonGiris = "-";
              if (
                u.sonGiris &&
                u.sonGiris.includes &&
                u.sonGiris.includes("T")
              ) {
                sonGiris = u.sonGiris.split("T")[0];
              }
              let dogumGunuGosterim = "-";
              let odulRozeti = "";

              if (u.dogumTarihi && u.dogumTarihi.length > 5) {
                // Tarihi temizle (T00:00:00 kƒ±smƒ±nƒ± at)
                let temizTarih = u.dogumTarihi.toString().split("T")[0];

                // Tarihi TR Formatƒ±na √áevir (YYYY-MM-DD -> DD.MM.YYYY)
                if (temizTarih.includes("-")) {
                  let p = temizTarih.split("-");
                  dogumGunuGosterim = `${p[2]}.${p[1]}.${p[0]}`;
                } else {
                  dogumGunuGosterim = temizTarih;
                }

                // √ñd√ºl Rozeti (Bu Yƒ±l Aldƒ±ysa)
                const buYil = new Date().getFullYear();
                // Backend'den 'sonOdulYili' geliyorsa kontrol et
                if (u.sonOdulYili == buYil) {
                  odulRozeti =
                    '<span title="Bu yƒ±l √∂d√ºl√ºn√º aldƒ±" style="cursor:help; font-size:14px;">üéÅ</span>';
                }
              }

              tbody.innerHTML += `<tr>
                <td><b>${u.adSoyad || "-"}</b></td>
                <td>${u.email}</td>
                <td><span class="badge ${lvlBadge}">${
                u.seviye || "√áaylak"
              }</span> <small>(${u.puan} XP)</small></td>              
                <td><span class="badge badge-info">${
                  u.siparisSayisi || 0
                } Adet</span></td>
                <td><span class="badge badge-warning">${hak} Hak</span> / ${katilim}</td>
                <td>${sonGiris} / <b style="color:red">${seriNo}</b></td>
                <td>${u.davetSayisi || 0}</td>
                <td>${dogumGunuGosterim} ${odulRozeti}</td>
                <td style="display:flex; gap:5px;">
                  <button class="btn btn-outline btn-sm" onclick="openGivePointModal('${
                    u.email
                  }')" title="D√ºzenle"><i class="fas fa-edit"></i></button>
                </td>
              </tr>`;
            });

            // ƒ∞mleci g√ºncelle
            lastUserCursor = data.lastId;

            // Eƒüer gelen veri 50'den azsa listenin sonuna geldik demektir
            if (btnMore) {
              if (data.users.length < 50) {
                btnMore.style.display = "none"; // Butonu gizle
              } else {
                btnMore.style.display = "inline-block"; // G√∂ster
                btnMore.innerText = "‚¨áÔ∏è Daha Fazla Y√ºkle";
              }
            }

            // ƒ∞lk sayfa y√ºklendiyse (ve loadMore deƒüilse) toplam sayƒ±larƒ± g√ºncellememiz gerekmez
            // √á√ºnk√º toplam sayƒ±larƒ± zaten Dashboard'dan (Adƒ±m 1) alƒ±yoruz.
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          console.error(e);
          if (!isLoadMore)
            tbody.innerHTML =
              '<tr><td colspan="9" style="color:red; text-align:center;">Hata olu≈ütu.</td></tr>';
        }
      }
      // --- üîç KULLANICI ARAMA ---
      function searchUsers() {
        const query = document.getElementById("userSearchInput").value;
        if (!query) return alert("L√ºtfen e-posta yazƒ±n.");
        // Arama modunda y√ºkle
        loadUsers(false, query);
      }

      function clearUserSearch() {
        document.getElementById("userSearchInput").value = "";
        loadUsers(); // Normale d√∂n
      }

      // --- üîç KATILIMCI ARAMA ---
      function searchParticipants() {
        const query = document.getElementById("partSearchInput").value;
        if (!query) return alert("L√ºtfen e-posta yazƒ±n.");
        loadParticipants(query);
      }

      function clearPartSearch() {
        document.getElementById("partSearchInput").value = "";
        loadParticipants();
      }

      // --- #18 √úR√úN HAVUZU (SKU) - HIZLI Y√úKLEME ---
      async function loadProducts() {
        const tbody = document.querySelector("#table-products tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="3"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor... (Limitli)</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_products" }),
          });
          const data = await res.json();

          if (data.success && Array.isArray(data.products)) {
            tbody.innerHTML = "";

            // DONMA ENGELLEYƒ∞Cƒ∞: Sadece ilk 100 √ºr√ºn√º g√∂ster
            const products = data.products.slice(0, 100);

            products.forEach((p) => {
              // ƒ∞sim kontrol√º
              const kod = p.stockCode || p.stokKodu || p.sku || "Bilinmiyor";

              let tarih = "-";
              if (p.eklenmeTarihi && p.eklenmeTarihi._seconds) {
                tarih = new Date(
                  p.eklenmeTarihi._seconds * 1000
                ).toLocaleDateString("tr-TR");
              }

              tbody.innerHTML += `
<tr>
<td style="font-family:monospace; font-weight:bold;">${kod}</td>
<td>${tarih}</td>
<td>
<button class="btn btn-outline btn-sm" style="color:red; border-color:red;" onclick="deleteProduct('${p.id}')">
<i class="fas fa-trash"></i>
          </button>
          </td>
          </tr>`;
            });

            // Alta uyarƒ± ekle
            if (data.products.length > 100) {
              tbody.innerHTML += `<tr><td colspan="3" style="text-align:center; color:#e67e22;">...ve ${
                data.products.length - 100
              } √ºr√ºn daha var (Performans i√ßin gizlendi).</td></tr>`;
            }
          } else {
            tbody.innerHTML = '<tr><td colspan="3">Veri yok.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML =
            '<tr><td colspan="3">Hata: ' + e.message + "</td></tr>";
        }
      }

      async function addSku() {
        const sku = document.getElementById("inputNewSku").value;
        if (!sku) return alert("Kod girin!");
        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "add_product_sku", stockCode: sku }),
        });
        closeModal("modalProduct");
        loadProducts();
      }

      async function deleteProduct(id) {
        if (!confirm("Silinsin mi?")) return;
        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "delete_product", id: id }),
        });
        loadProducts();
      }
      // --- TOPLU Sƒ∞LME ---
      async function deleteAllProducts() {
        if (
          !confirm(
            "Dƒ∞KKAT: √úr√ºn havuzundaki T√úM stok kodlarƒ± silinecek! Emin misiniz?"
          )
        )
          return;

        const btn = document.querySelector(
          'button[onclick="deleteAllProducts()"]'
        );
        const originalText = btn.innerHTML;
        btn.innerHTML = "Siliniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "delete_all_products" }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            loadProducts();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerHTML = originalText;
        btn.disabled = false;
      }

      // --- TOPLU Y√úKLEME (METƒ∞N) ---
      async function addBulkSkus() {
        const textData = document.getElementById("inputBulkSkus").value;
        if (!textData.trim()) return alert("L√ºtfen kodlarƒ± yapƒ±≈ütƒ±rƒ±n.");

        const btn = document.querySelector("#modalBulkProduct button");
        btn.innerText = "Y√ºkleniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "bulk_add_products_text",
              textData: textData,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            closeModal("modalBulkProduct");
            document.getElementById("inputBulkSkus").value = ""; // Temizle
            loadProducts();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerText = "Y√ºkle ve Kaydet";
        btn.disabled = false;
      }

      async function importMockSkus() {
        const mocks = [
          "TSHIRT-001",
          "KAZAK-55",
          "PANT-MAVI-32",
          "ATKI-YUN",
          "BERE-SIYAH",
        ];
        if (confirm("√ñrnek stok kodlarƒ± eklensin mi?")) {
          await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "admin_import_skus", skus: mocks }),
          });
          loadProducts();
        }
      }

      // --- #16 Sƒ∞STEM VERƒ∞Sƒ∞ (KODLAR + HAVUZ) ---
      async function loadDailyCodes() {
        const divCodes = document.getElementById("daily-golden-codes");
        const divPool = document.getElementById("legendPoolAmount");

        divCodes.innerHTML = "Y√ºkleniyor...";
        divPool.innerText = "Y√ºkleniyor...";

        try {
          // 1. Altƒ±n √úr√ºnleri √áek
          const resCodes = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_daily_golden_codes" }),
          });
          const dataCodes = await resCodes.json();

          if (dataCodes.success) {
            divCodes.innerHTML = "";
            if (dataCodes.codes.length === 0)
              divCodes.innerHTML = "Bug√ºn hen√ºz se√ßilmedi.";
            dataCodes.codes.forEach((c) => {
              divCodes.innerHTML += `<div style="background:#fefce8; border:1px solid #fde047; padding:10px 20px; border-radius:8px; font-weight:bold; color:#854d0e;">${c}</div>`;
            });
          }

          // 2. Efsane Havuzunu √áek (Bunun i√ßin backend'e k√º√ß√ºk bir istek daha lazƒ±m veya get_settings ile alabiliriz)
          // Ama ≈üu an basit√ße 'get_settings' i√ßinde havuzu da d√∂nmesini saƒülayalƒ±m veya ayrƒ± bir okuma yapalƒ±m.
          // EN KOLAY YOL: Backend'e 'get_system_data' eklemek.

          const resPool = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_system_data" }),
          });
          const dataPool = await resPool.json();

          if (dataPool.success) {
            // TL Formatƒ±
            const amount = dataPool.data.legendPool || 0;
            divPool.innerText = amount.toLocaleString("tr-TR", {
              style: "currency",
              currency: "TRY",
            });
          }
        } catch (e) {
          divCodes.innerHTML = "Hata.";
          divPool.innerText = "Hata.";
        }
      } // --- #10 AYARLAR (AKILLI HAFIZA MODU) ---
      async function loadSettings(forceRefresh = false) {
        // Eƒüer butona basƒ±ldƒ±ysa hafƒ±zayƒ± temizle
        if (forceRefresh) clearCache("settings");

        try {
          // smartFetch kullanƒ±yoruz (30 Dakika Hatƒ±rlasƒ±n)
          const data = await smartFetch("get_settings", "settings", 30);

          if (data.success) {
            const s = data.settings;
            // Formu doldur
            document.getElementById("set_xp_katilim").value = s.xp_katilim;
            document.getElementById("set_xp_gunluk").value = s.xp_gunluk;
            document.getElementById("set_xp_referans").value = s.xp_referans;
            document.getElementById("set_xp_dogumtarihi").value =
              s.xp_dogumtarihi;

            document.getElementById("set_order_min_usta").value =
              s.order_min_usta || 1;
            document.getElementById("set_order_min_sampiyon").value =
              s.order_min_sampiyon || 2;
            document.getElementById("set_order_min_efsane").value =
              s.order_min_efsane || 5;

            document.getElementById("set_siparis_xp_l1").value =
              s.siparis_xp_l1;
            document.getElementById("set_siparis_xp_l2").value =
              s.siparis_xp_l2;
            document.getElementById("set_siparis_xp_l3").value =
              s.siparis_xp_l3;
            document.getElementById("set_siparis_xp_l4").value =
              s.siparis_xp_l4;

            document.getElementById("set_siparis_limit_l2").value =
              s.siparis_limit_l2;
            document.getElementById("set_siparis_limit_l3").value =
              s.siparis_limit_l3;
            document.getElementById("set_siparis_limit_l4").value =
              s.siparis_limit_l4;

            document.getElementById("set_lvl_usta_min").value = s.lvl_usta_min;
            document.getElementById("set_lvl_sampiyon_min").value =
              s.lvl_sampiyon_min;
            document.getElementById("set_lvl_efsane_min").value =
              s.lvl_efsane_min;

            document.getElementById("set_max_ip_istek").value = s.max_ip_istek;
            document.getElementById("set_daily_secret_code").value =
              s.daily_secret_code || "";

            document.getElementById("set_xp_yillik_dogumgunu").value =
              s.xp_yillik_dogumgunu || 500;
            document.getElementById("set_hak_yillik_dogumgunu").value =
              s.hak_yillik_dogumgunu || 0;
            document.getElementById("set_xp_hosgeldin").value =
              s.xp_hosgeldin || 50;

            if (s.active_theme) {
              document.getElementById("set_active_theme").value =
                s.active_theme;
            } else {
              document.getElementById("set_active_theme").value = "default";
            }

            if (data.fromCache) console.log("‚úÖ Ayarlar √∂nbellekten geldi.");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function saveSettings() {
        const payload = {
          islem: "save_settings",
          xp_katilim: document.getElementById("set_xp_katilim").value,
          xp_yillik_dogumgunu: document.getElementById(
            "set_xp_yillik_dogumgunu"
          ).value,
          hak_yillik_dogumgunu: document.getElementById(
            "set_hak_yillik_dogumgunu"
          ).value,
          xp_gunluk: document.getElementById("set_xp_gunluk").value,
          xp_referans: document.getElementById("set_xp_referans").value,
          xp_dogumtarihi: document.getElementById("set_xp_dogumtarihi").value,
          lvl_usta_min: document.getElementById("set_lvl_usta_min").value,
          lvl_sampiyon_min: document.getElementById("set_lvl_sampiyon_min")
            .value,
          lvl_efsane_min: document.getElementById("set_lvl_efsane_min").value,
          max_ip_istek: document.getElementById("set_max_ip_istek").value,
          order_min_usta: document.getElementById("set_order_min_usta").value,
          order_min_sampiyon: document.getElementById("set_order_min_sampiyon")
            .value,
          order_min_efsane: document.getElementById("set_order_min_efsane")
            .value,
          // ... payload objesinin i√ßine ekle ...
          siparis_xp_l1: document.getElementById("set_siparis_xp_l1").value,
          siparis_xp_l2: document.getElementById("set_siparis_xp_l2").value,
          siparis_xp_l3: document.getElementById("set_siparis_xp_l3").value,
          siparis_xp_l4: document.getElementById("set_siparis_xp_l4").value,
          xp_hosgeldin: document.getElementById("set_xp_hosgeldin").value,

          siparis_limit_l2: document.getElementById("set_siparis_limit_l2")
            .value,
          siparis_limit_l3: document.getElementById("set_siparis_limit_l3")
            .value,
          siparis_limit_l4: document.getElementById("set_siparis_limit_l4")
            .value,
          daily_secret_code: document.getElementById("set_daily_secret_code")
            .value,
          active_theme: document.getElementById("set_active_theme").value,
        };
        if (confirm("Ayarlar kaydedilsin mi?")) {
          await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          alert("Ayarlar g√ºncellendi.");
        }
        clearCache("settings"); // <--- BUNU EKLE
        loadSettings();
      }
      // SADECE TEMAYI KAYDEDER (Diƒüer ayarlarƒ± bozmaz)
      async function saveThemeOnly() {
        const themeVal = document.getElementById("set_active_theme").value;

        // Backend merge:true kullandƒ±ƒüƒ± i√ßin sadece g√∂nderdiƒüimiz alanƒ± g√ºnceller
        const payload = {
          islem: "save_settings",
          active_theme: themeVal,
        };

        const btn = document.querySelector("#header-theme-area button");
        const oldText = btn.innerText;
        btn.innerText = "...";
        btn.disabled = true;

        try {
          await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          alert("‚úÖ Tema g√ºncellendi: " + themeVal);
        } catch (e) {
          alert("Hata: " + e);
        }

        btn.innerText = oldText;
        btn.disabled = false;
      }

      // --- MANUEL PUAN ƒ∞≈ûLEMƒ∞ ---
      async function submitPointAction() {
        const email = document.getElementById("inputPointEmail").value;
        const amount = document.getElementById("inputPointAmount").value;
        const type = document.getElementById("selectPointAction").value;

        if (!email || !amount) return alert("E-posta ve miktar giriniz.");

        const btn = document.querySelector("#modalGivePoint button");
        btn.innerText = "ƒ∞≈üleniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "admin_update_points",
              email,
              amount,
              type,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert("Ba≈üarƒ±lƒ±! Yeni Seviye: " + data.newLevel);
            closeModal("modalGivePoint");
            // Kullanƒ±cƒ±lar sayfasƒ±nƒ± yenile (eƒüer a√ßƒ±ksa) veya Dashboard'u
            loadUsers();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Baƒülantƒ± hatasƒ±.");
        }

        btn.innerText = "ƒ∞≈ülemi Uygula";
        btn.disabled = false;
      } // --- G√úVENLƒ∞K LOGLARI (Fƒ∞XED) ---
      async function loadSecurityLogs() {
        const tbody = document.querySelector("#table-securityLogs tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; padding:20px; color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Loglar Taranƒ±yor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_security_logs" }),
          });
          const data = await res.json();

          if (data.success && data.logs.length > 0) {
            tbody.innerHTML = "";

            // --- üî• YENƒ∞ EKLENEN LOGGER SIRALAMA KODU (BA≈ûLANGI√á) ---
            data.logs.sort((a, b) => {
              // Varsa timestamp (createdAt), yoksa tarih stringi (tarih) √ºzerinden kar≈üƒ±la≈ütƒ±r
              const timeA = a.createdAt
                ? a.createdAt._seconds * 1000
                : new Date(a.tarih || 0).getTime();
              const timeB = b.createdAt
                ? b.createdAt._seconds * 1000
                : new Date(b.tarih || 0).getTime();

              return timeB - timeA; // B√ºy√ºk olan (En Yeni) en √ºste √ßƒ±kar
            });
            // --- üî• YENƒ∞ EKLENEN LOGGER SIRALAMA KODU (Bƒ∞Tƒ∞≈û) ---

            data.logs.forEach((log) => {
              // ... (kodun geri kalanƒ± aynƒ±)
              // Renklendirme
              let badgeClass = "badge-info"; // Mavi (Varsayƒ±lan)
              const act = (log.action || "").toUpperCase();

              if (
                act.includes("BLOK") ||
                act.includes("HATA") ||
                act.includes("BAN")
              )
                badgeClass = "badge-danger"; // Kƒ±rmƒ±zƒ±

              if (
                act.includes("IZNI") ||
                act.includes("BA≈ûARILI") ||
                act.includes("ABONE") ||
                act.includes("YENI")
              )
                badgeClass = "badge-success"; // Ye≈üil

              if (act.includes("SILME") || act.includes("KUPON"))
                badgeClass = "badge-warning"; // Sarƒ±

              tbody.innerHTML += `
                <tr>
                    <td style="white-space:nowrap; font-size:0.85rem; font-family:monospace; color:#334155;"><b>${log.createdAt}</b></td>
                    <td><span class="badge ${badgeClass}">${log.action}</span></td>
                    <td style="font-size:0.9rem; color:#475569;">${log.details}</td>
                    <td style="font-family:monospace; font-size:0.8rem; color:#64748b;">${log.ip}</td>
                </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">Kayƒ±t bulunamadƒ±.</td></tr>';
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="4" style="color:red; text-align:center;">Veri √ßekilemedi.</td></tr>';
        }
      } // --- #13 Sƒ∞STEM LOGLARI (CANLI & TR SAATƒ∞) ---
      async function loadSystemLogs() {
        const tbody = document.querySelector("#table-systemLogs tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="4"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_system_logs" }),
          });
          const data = await res.json();

          if (data.success && data.logs.length > 0) {
            tbody.innerHTML = "";
            data.logs.forEach((log) => {
              // TARƒ∞H D√úZELTME (T√úRKƒ∞YE SAATƒ∞)
              let dateDisplay = "-";
              if (log.tarih && log.tarih.includes && log.tarih.includes("T")) {
                // Eƒüer timestamp string geldiyse
                dateDisplay = new Date(log.tarih).toLocaleString("tr-TR");
              } else if (log.createdAt && log.createdAt._seconds) {
                // Eƒüer Firebase Timestamp geldiyse
                dateDisplay = new Date(
                  log.createdAt._seconds * 1000
                ).toLocaleString("tr-TR", { timeZone: "Europe/Istanbul" });
              } else {
                dateDisplay = log.tarih || "-";
              }

              // RENKLENDƒ∞RME
              let badge = "badge-info"; // Mavi (Varsayƒ±lan)
              const act = (log.action || "").toUpperCase();

              if (act.includes("KAZAN")) badge = "badge-warning"; // Sarƒ± (√ñd√ºl)
              if (act.includes("SATIN")) badge = "badge-success"; // Ye≈üil (Satƒ±≈ü)
              if (act.includes("SEKME")) badge = "badge-dark"; // Gri (Gezinme)

              tbody.innerHTML += `<tr>
                <td style="white-space:nowrap; font-size:0.8rem; color:#64748b;">${dateDisplay}</td>
                <td><b>${log.email}</b></td>
                <td><span class="badge ${badge}">${log.action}</span></td>
                <td style="color:#334155; font-size:0.85em;">${log.details}</td>
              </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align:center;">Hen√ºz kayƒ±t yok.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="4">Log bulunamadƒ±.</td></tr>';
        }
      }

      // G√ñREVLERƒ∞ Lƒ∞STELE (TABLO G√úNCELLEMESƒ∞)
      async function loadTasks(forceRefresh = false) {
        const tbody = document.querySelector("#table-tasks tbody");
        if (forceRefresh) {
          clearCache("tasks");
          tbody.innerHTML = '<tr><td colspan="5">Y√ºkleniyor...</td></tr>';
        } else {
          // ƒ∞lk a√ßƒ±lƒ±≈üta bo≈üsa g√∂ster
          if (tbody.innerHTML.trim() === "")
            tbody.innerHTML = '<tr><td colspan="5">Y√ºkleniyor...</td></tr>';
        }
        const data = await smartFetch("get_tasks", "tasks", 10);

        if (data.success) {
          // Verileri hafƒ±zaya atƒ±yoruz (Edit yaparken kullanacaƒüƒ±z)
          globalTaskList = data.tasks;
          tbody.innerHTML = "";
          // index.html -> loadTasks fonksiyonu i√ßi

          data.tasks.forEach((t) => {
            // 1. D√úZELTME: Durum Kontrol√º (Hem boolean hem string kontrol√º)
            // Veritabanƒ±nda "aktif: true" veya "status: active" ise ye≈üil yap
            const isActive =
              t.status === "active" || t.aktif === true || t.aktif === "TRUE";

            const badgeClass = isActive ? "badge-success" : "badge-danger";
            const statusText = isActive ? "Aktif" : "Pasif";

            // 2. D√úZELTME: Tip Kontrol√º ve T√ºrk√ßele≈ütirme
            let hamTip = t.tip || t.frequency || "Genel";
            let tipGosterimi = hamTip;

            if (hamTip === "GUNLUK") tipGosterimi = "G√úNL√úK";
            if (hamTip === "TEK") tipGosterimi = "TEK SEFERLƒ∞K";
            if (hamTip === "HAFTALIK") tipGosterimi = "HAFTALIK";
            if (hamTip === "ETKINLIK") tipGosterimi = "ETKƒ∞NLƒ∞K";

            // 3. D√úZELTME: Adƒ±mlarƒ± G√∂ster
            // index.html -> loadTasks fonksiyonu -> HTML olu≈üturma kƒ±smƒ±

            // √ñnce adƒ±mlarƒ± kontrol edip bir deƒüi≈ükene atayalƒ±m (D√∂ng√ºn√ºn i√ßinde, innerHTML'den hemen √∂nce)
            let stepsInfo = "";
            if (t.adim1_tanim) {
              stepsInfo += `<div style="font-size:11px; color:#444; margin-top:6px; background:#f1f5f9; padding:4px; border-radius:4px;">
<i class="fas fa-check-square"></i> 1: ${t.adim1_tanim}
          </div>`;
            }
            if (t.adim2_tanim) {
              stepsInfo += `<div style="font-size:11px; color:#444; margin-top:2px; background:#f1f5f9; padding:4px; border-radius:4px;">
<i class="fas fa-check-square"></i> 2: ${t.adim2_tanim}
          </div>`;
            }

            // loadTasks fonksiyonunun i√ßindeki HTML olu≈üturma kƒ±smƒ±:
            tbody.innerHTML += `
            <tr>
              <td><small style="font-family:monospace; color:#aaa; font-size:10px;">${
                t.id
              }</small></td>
              <td>
                <b style="font-size:1.1em; color:#1e293b;">${t.title}</b><br>
                <div style="color:#64748b; font-size:0.9em; margin-bottom:5px;">${
                  t.description
                }</div>
                ${stepsInfo}
              </td>
              <td><span class="badge badge-info">${
                t.type || t.frequency
              }</span></td>
              <td><small style="font-family:monospace; color:#6366f1;">${
                t.adim1_gorevtipi || "-"
              }</small></td>
              <td><small style="font-family:monospace; color:#6366f1;">${
                t.adim2_gorevtipi || "-"
              }</small></td>
              <td style="font-weight:bold; color:#e67e22;">${t.reward} XP</td>
              <td>
                <span class="badge ${badgeClass}" style="cursor:pointer;" onclick="toggleTaskStatus('${
              t.id
            }')">
                  ${statusText} (Deƒüi≈ütir)
                </span>
              </td>
              <td>
                <div style="display:flex; gap:5px;">
                    <button class="btn btn-primary btn-sm" onclick="editTaskMode('${
                      t.id
                    }')" title="D√ºzenle">
                        <i class="fas fa-edit"></i>
                    </button>
                    
                    <button class="btn btn-outline btn-sm" onclick="deleteTask('${
                      t.id
                    }')" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
              </td>
            </tr>`;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="5">Veri yok.</td></tr>';
        }
      }
      // --- D√úZENLEME MODUNU A√á ---
      function editTaskMode(id) {
        // 1. G√∂revi bul
        const task = globalTaskList.find((t) => t.id === id);
        if (!task) return alert("G√∂rev bulunamadƒ±.");

        // 2. Global deƒüi≈ükeni ayarla
        editingTaskId = id;

        // 3. Modalƒ± Temizle ve Ba≈ülƒ±ƒüƒ± Deƒüi≈ütir
        document.querySelector("#modalTask h3").innerText = "G√∂revi D√ºzenle";
        const saveBtn = document.querySelector("#modalTask button.btn-primary");
        saveBtn.innerText = "G√ºncelle ve Kaydet";

        // 4. Formu Doldur (Mapping)
        document.getElementById("custom_task_id").value =
          task.customId || task.id;
        document.getElementById("custom_task_id").disabled = true; // ID deƒüi≈ütirilemez olsun

        // Sƒ±klƒ±k se√ßimi
        document.getElementById("task_frequency").value =
          task.frequency || task.type || "TEK";

        document.getElementById("taskTitle").value = task.title || task.baslik;
        document.getElementById("taskDesc").value =
          task.description || task.aciklama;
        document.getElementById("taskReward").value =
          task.reward || task.buyukodul_xp || 0;
        document.getElementById("taskRewardRights").value =
          task.buyukodul_hak || 0;

        // Adƒ±m 1
        document.getElementById("step1Type").value = task.adim1_gorevtipi || "";
        document.getElementById("step1Desc").value = task.adim1_tanim || "";
        document.getElementById("step1Link").value = task.adim1_link || "";
        document.getElementById("step1Target").value = task.adim1_hedef || 1;

        // Adƒ±m 2
        document.getElementById("step2Type").value = task.adim2_gorevtipi || "";
        document.getElementById("step2Desc").value = task.adim2_tanim || "";

        // 5. Modalƒ± A√ß
        openModal("modalTask");
      }

      // --- YENƒ∞ EKLERKEN MODALI TEMƒ∞ZLE ---
      function openNewTaskModal() {
        editingTaskId = null; // Yeni kayƒ±t modu

        // Ba≈ülƒ±klarƒ± d√ºzelt
        document.querySelector("#modalTask h3").innerText =
          "Yeni G√∂rev Olu≈ütur";
        const saveBtn = document.querySelector("#modalTask button.btn-primary");
        saveBtn.innerText = "Kaydet ve Olu≈ütur";

        // Formu temizle
        document.getElementById("custom_task_id").value = "";
        document.getElementById("custom_task_id").disabled = false; // ID girilebilir olsun
        document.getElementById("taskTitle").value = "";
        document.getElementById("taskDesc").value = "";
        document.getElementById("taskReward").value = "50";
        document.getElementById("taskRewardRights").value = "0";

        document.getElementById("step1Type").value = "";
        document.getElementById("step1Desc").value = "";
        document.getElementById("step1Link").value = "";

        document.getElementById("step2Type").value = "";
        document.getElementById("step2Desc").value = "";

        openModal("modalTask");
      } // G√ñREV KAYDETME (AKILLI VERSƒ∞YON: HEM EKLE HEM G√úNCELLE)
      async function submitNewTask() {
        // 1. Formdaki Verileri Al
        var title = document.getElementById("taskTitle").value;
        var desc = document.getElementById("taskDesc").value;
        var rewardXP = document.getElementById("taskReward").value;
        var rewardHak = document.getElementById("taskRewardRights").value;

        var frequencySelect = document.getElementById("task_frequency");
        var frequency =
          frequencySelect.options[frequencySelect.selectedIndex].value;
        var customId = document.getElementById("custom_task_id").value;

        // Adƒ±m 1 Verileri
        var s1Type = document.getElementById("step1Type").value;
        var s1Desc = document.getElementById("step1Desc").value;
        var s1Link = document.getElementById("step1Link").value;
        var s1Target = document.getElementById("step1Target").value;

        // Adƒ±m 2 Verileri
        var s2Type = document.getElementById("step2Type").value;
        var s2Desc = document.getElementById("step2Desc").value;

        // Basit Kontrol
        if (!title) return alert("L√ºtfen bir ba≈ülƒ±k girin.");

        // Link D√ºzeltmesi (Instagram i√ßin)
        if (s1Type === "instagram" && (!s1Link || s1Link.trim() === "")) {
          s1Link = "https://instagram.com/modumnetco";
        }

        // Butonu Kilitle (Tƒ±klanmasƒ±n)
        const btn = document.querySelector("#modalTask button.btn-primary");
        const originalText = btn.innerText;
        btn.innerText = "ƒ∞≈üleniyor...";
        btn.disabled = true;

        // 2. ORTAK VERƒ∞ PAKETƒ∞ HAZIRLA
        const coreData = {
          customId: customId,
          tip: frequency,
          frequency: frequency,
          baslik: title,
          title: title,
          aciklama: desc,
          description: desc,
          buyukodul_xp: parseInt(rewardXP) || 0,
          reward: parseInt(rewardXP) || 0,
          buyukodul_hak: parseInt(rewardHak) || 0,

          adim1_tanim: s1Desc,
          adim1_gorevtipi: s1Type,
          adim1_link: s1Link,
          adim1_hedef: parseInt(s1Target) || 1,

          adim2_tanim: s2Desc,
          adim2_gorevtipi: s2Type,
          adim2_hedef: 1,

          // Varsayƒ±lan deƒüerler
          aktif: true,
          status: "active",
        };

        // 3. KARAR ANI: G√úNCELLEME Mƒ∞, YENƒ∞ KAYIT MI?
        let payload = {};

        if (editingTaskId) {
          // üî• G√úNCELLEME MODU (Edit)
          payload = {
            islem: "update_task_def",
            taskId: editingTaskId, // Hangi g√∂revi g√ºncelliyoruz?
            newData: coreData, // Yeni veriler
          };
        } else {
          // üî• YENƒ∞ KAYIT MODU (New)
          payload = {
            islem: "add_task",
            ...coreData, // Verileri direkt ekle
          };
        }

        // 4. Sunucuya G√∂nder
        try {
          await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          // Ba≈üarƒ± Mesajƒ±
          if (editingTaskId) {
            alert("‚úÖ G√∂rev Ba≈üarƒ±yla G√ºncellendi!");
          } else {
            alert("‚úÖ Yeni G√∂rev Olu≈üturuldu!");
          }

          closeModal("modalTask"); // Pencereyi kapat
          setTimeout(() => {
            loadTasks(true);
          }, 1000); // Listeyi yenile
        } catch (e) {
          alert("Hata: " + e);
        }

        // Butonu Eski Haline Getir
        btn.innerText = originalText;
        btn.disabled = false;
      }

      async function deleteTask(id) {
        if (!confirm("Bu g√∂rev silinsin mi?")) return;
        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "delete_task", id: id }),
        });
        loadTasks();
      }

      async function toggleTaskStatus(id) {
        if (!confirm("Durumu deƒüi≈ütirmek istiyor musun?")) return;

        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "toggle_task_status", id: id }),
        });
        loadTasks(); // Tabloyu yenile
      } // --- #2 √áEKƒ∞Lƒ∞≈û Y√ñNETƒ∞Mƒ∞ (Sƒ∞LME BUTONLU VERSƒ∞YON) ---
      async function loadRaffles() {
        const tbody = document.querySelector("#table-raffles tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_raffles" }),
          });
          const data = await res.json();

          if (data.success && Array.isArray(data.raffles)) {
            tbody.innerHTML = "";

            // --- üî• YENƒ∞ EKLENEN SIRALAMA KODU (BA≈ûLANGI√á) ---
            data.raffles.sort((a, b) => {
              // 1. Kriter: Aktifler her zaman en √ºstte olsun
              const statusA = (a.durum || a.status || "").toLowerCase();
              const statusB = (b.durum || b.status || "").toLowerCase();
              const isActiveA = statusA === "active" || statusA === "aktif";
              const isActiveB = statusB === "active" || statusB === "aktif";

              if (isActiveA && !isActiveB) return -1; // A yukarƒ±
              if (!isActiveA && isActiveB) return 1; // B yukarƒ±

              // 2. Kriter: Tarihe g√∂re (En yeni tarihli en √ºstte)
              const dateA = new Date(a.bitisTarihi || a.endDate || 0).getTime();
              const dateB = new Date(b.bitisTarihi || b.endDate || 0).getTime();
              return dateB - dateA; // Yeniden eskiye
            });
            // --- üî• YENƒ∞ EKLENEN SIRALAMA KODU (Bƒ∞Tƒ∞≈û) ---

            if (data.raffles.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center;">Hen√ºz √ßekili≈ü yok.</td></tr>';
              return;
            }

            data.raffles.forEach((r) => {
              const ad = r.ad || r.name || "ƒ∞simsiz √áekili≈ü";
              const odul = r.odul || r.reward || "-";

              // Tarih formatlama
              let bitisStr = "-";
              if (r.bitisTarihi) bitisStr = r.bitisTarihi.replace("T", " ");
              else if (r.endDate) bitisStr = r.endDate.replace("T", " ");

              const durum = r.durum || r.status || "pasif";

              // Tarih kontrol√º
              let isActive = false;
              try {
                let cleanDate = bitisStr.replace(" ", "T");
                if (cleanDate.length <= 16) cleanDate += ":00";
                const endDateObj = new Date(cleanDate);
                const now = new Date();
                if (endDateObj > now) isActive = true;
              } catch (e) {}

              // Status kontrol√º
              const isNotFinished =
                durum !== "completed" &&
                durum !== "cancelled" &&
                durum !== "Tamamlandƒ±";
              if ((durum === "active" || durum === "Aktif") && isNotFinished)
                isActive = true;

              const statusBadge = isActive
                ? '<span class="badge badge-success">Aktif</span>'
                : '<span class="badge badge-dark">Tamamlandƒ±</span>';

              let buttons = "";
              // üî• YENƒ∞: Sƒ∞LME BUTONU EKLENDƒ∞ (HER DURUMDA G√ñR√úN√úR)
              const deleteBtn = `<button class="btn btn-danger btn-sm" onclick="deleteRaffle('${r.id}')" title="Sil" style="padding:4px 8px; margin-left:5px;"><i class="fas fa-trash"></i></button>`;

              if (isActive) {
                buttons = `
                <button class="btn btn-info btn-sm" style="padding:4px 8px; font-size:10px" onclick="simulateParticipants('${r.id}')">+10 Test</button>
                <button class="btn btn-primary btn-sm" style="padding:4px 8px;" onclick="editRaffleDate('${r.id}', '${bitisStr}')" title="Tarihi Deƒüi≈ütir"><i class="fas fa-edit"></i></button>
                <button class="btn btn-warning btn-sm" onclick="finishRaffle('${r.id}')">Bitir</button>
                ${deleteBtn} 
                `;
              } else {
                buttons = `
                <button class="btn btn-outline btn-sm" onclick="showPage('winners', 'Kazananlar', 'Sonu√ßlar')">Sonu√ß G√∂r</button>
                ${deleteBtn}
                `;
              }

              tbody.innerHTML += `
              <tr>
                <td><b>${ad}</b></td>
                <td>${bitisStr}</td>
                <td>${odul}</td>
                <td>${r.participantCount || 0} / ${
                r.winnerCount || r.kazanan_sayisi || 1
              }</td>
                <td>${statusBadge}</td>
                <td style="display:flex; gap:5px;">${buttons}</td>
              </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="6">Veri alƒ±namadƒ±.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="6">Baƒülantƒ± hatasƒ±.</td></tr>';
        }
      }

      // --- √áEKƒ∞Lƒ∞≈û Sƒ∞LME FONKSƒ∞YONU ---
      async function deleteRaffle(id) {
        if (
          !confirm(
            "‚ö†Ô∏è Dƒ∞KKAT: Bu √ßekili≈ü kalƒ±cƒ± olarak silinecek! Onaylƒ±yor musun?"
          )
        )
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "delete_raffle", id: id }),
          });
          const data = await res.json();

          if (data.success) {
            alert("‚úÖ Silindi.");
            loadRaffles(); // Listeyi yenile
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Baƒülantƒ± hatasƒ±: " + e);
        }
      } // --- üî• ADIM 2: KAYDET VE KAPAT ---
      async function createRaffle() {
        var name = document.getElementById("rafName").value;
        var endDate = document.getElementById("rafDate").value;
        var reward = document.getElementById("rafReward").value;
        var winners = document.getElementById("rafWinners").value;

        if (!name || !endDate || !reward) {
          alert("‚ö†Ô∏è L√ºtfen t√ºm alanlarƒ± doldurun!");
          return;
        }

        var btn = document.getElementById("btnCreateRaffle");
        if (btn) {
          btn.innerText = "‚è≥ Olu≈üturuluyor...";
          btn.disabled = true;
        }

        const payload = {
          islem: "create_raffle",
          name: name,
          endDate: endDate,
          reward: reward,
          winnerCount: winners,
        };

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          if (data.success) {
            alert("‚úÖ " + data.message);
          } else {
            alert("‚ùå " + data.message);
          }
        } catch (e) {
          console.log(
            "Baƒülantƒ± hatasƒ± (√ñnemli deƒüil, i≈ülem yapƒ±lmƒ±≈ü olabilir)"
          );
        } finally {
          // --- PENCEREYƒ∞ ZORLA KAPAT ---
          const fixedModal = document.getElementById("modalRaffleFixed");
          if (fixedModal) fixedModal.remove();

          loadRaffles(); // Listeyi yenile
        }
      }

      async function simulateParticipants(id) {
        if (!confirm("Bu √ßekili≈üe 10 adet sahte test kullanƒ±cƒ±sƒ± eklensin mi?"))
          return;
        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            islem: "simulate_participants",
            raffleId: id,
            count: 10,
          }),
        });
        loadRaffles();
        alert("10 Katƒ±lƒ±mcƒ± eklendi!");
      }

      async function finishRaffle(id) {
        if (
          !confirm(
            "√áekili≈ü sonlandƒ±rƒ±lacak ve kazananlar belirlenecek. Emin misiniz?"
          )
        )
          return;
        const res = await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "draw_raffle", raffleId: id }),
        });
        const data = await res.json();
        if (data.success) {
          alert(
            "√áekili≈ü Bitti! Kazananlar: \n" +
              data.winners.map((w) => w.userName).join(", ")
          );
          loadRaffles();
        } else {
          alert("Hata: " + data.message);
        }
      }
      // --- HATA AYIKLAMA TABLOSU (FRONTEND) ---
      async function loadUserProgress() {
        const tbody = document.querySelector("#table-userProgress tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center;">‚è≥ Veriler √áekiliyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_all_user_progress" }),
          });

          const data = await res.json();

          if (data.success) {
            tbody.innerHTML = "";
            if (data.list.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center;">Kayƒ±t bulunamadƒ±.</td></tr>';
              return;
            }

            data.list.forEach((item) => {
              let badge = `<span class="badge badge-warning">${item.status}</span>`;
              if (item.status === "TAMAMLANDI")
                badge = `<span class="badge badge-success">TAMAMLANDI</span>`;

              tbody.innerHTML += `
<tr>
<td style="font-size:12px;">${item.date}</td>
<td style="font-weight:bold;">${item.email}</td>
<td style="font-size:11px; color:#555;">${item.taskId}</td>
<td style="color:#007bff;">${item.taskTitle}</td>
<td style="font-size:12px;">${item.steps}</td>
<td>${badge}</td>
          </tr>`;
            });
          } else {
            tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">SERVER HATASI: ${data.error}</td></tr>`;
          }
        } catch (e) {
          tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">BAƒûLANTI HATASI: ${e.message}</td></tr>`;
        }
      }
      // --- #1 KATILIMCILAR (ƒ∞≈ûLEM Tƒ∞Pƒ∞ EKLENDƒ∞) ---
      async function loadParticipants(searchQuery = null) {
        const tbody = document.querySelector("#table-participants tbody");
        const thead = document.querySelector("#table-participants thead tr");

        // Ba≈ülƒ±k satƒ±rƒ±nƒ± g√ºncelle (Eƒüer 5. s√ºtun yoksa ekle)
        if (thead && thead.children.length < 5) {
          thead.innerHTML += "<th>ƒ∞≈ülem Tipi</th>";
        }

        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="5">Y√ºkleniyor...</td></tr>';
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "get_participants",
              searchQuery: searchQuery,
            }),
          });
          const data = await res.json();
          if (data.success) {
            tbody.innerHTML = "";

            // --- üî• YENƒ∞ EKLENEN SIRALAMA KODU (BA≈ûLANGI√á) ---
            data.list.sort((a, b) => {
              // Varsa _sortScore (kesin zaman damgasƒ±) kullan, yoksa tarihi √ßevir
              const timeA = a._sortScore
                ? a._sortScore
                : new Date(a.createdAt || a.date || 0).getTime();
              const timeB = b._sortScore
                ? b._sortScore
                : new Date(b.createdAt || b.date || 0).getTime();

              return timeB - timeA; // B√ºy√ºk olan (yeni olan) en √ºste
            });
            // ... (loadParticipants i√ßindeki data.list.forEach kƒ±smƒ±) ...

            data.list.forEach((p) => {
              // Renklendirme
              let badgeClass = "badge-info";
              let typeText = p.type || "Katƒ±lƒ±m";

              if (typeText.includes("Hak")) {
                badgeClass = "badge-warning"; // Turuncu
                typeText = "üéÅ " + typeText;
              } else if (typeText.includes("Katƒ±lƒ±m")) {
                badgeClass = "badge-success"; // Ye≈üil
                typeText = "‚úÖ Katƒ±lƒ±m";
              }

              // üî• TARƒ∞H Fƒ∞X: Hangi veri doluysa onu alƒ±p formatla
              // Backend bazen 'createdAt', bazen 'date', bazen 'tarih' g√∂nderiyor olabilir.
              // Biz hepsini deniyoruz, formatTrDate hepsini halleder.
              // Ayrƒ±ca _sortScore varsa en garantisi odur (saniyesine kadar tutar).

              let hamTarih = p._sortScore
                ? { _seconds: p._sortScore / 1000 }
                : p.createdAt || p.date || p.tarih;
              let finalDate = formatTrDate(hamTarih);

              tbody.innerHTML += `<tr>
                <td style="font-family:monospace; color:#64748b; font-weight:bold;">${finalDate}</td>
                <td>${p.raffleName}</td>
                <td><b>${p.name}</b><br><small>${p.email}</small></td>
                <td><span class="badge badge-dark" style="font-family:monospace">${p.ticketId}</span></td>
                <td><span class="badge ${badgeClass}">${typeText}</span></td>
              </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="5">Veri yok.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="5">Hata olu≈ütu.</td></tr>';
        }
      }
      // --- #3 KAZANANLAR (TARƒ∞H Fƒ∞X) ---
      async function loadWinners() {
        const tbody = document.querySelector("#table-winners tbody");
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="5">Y√ºkleniyor...</td></tr>';
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_winners" }),
          });
          const data = await res.json();
          if (data.success) {
            tbody.innerHTML = "";

            // Eƒüer liste bo≈üsa
            if (data.winners.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="5" style="text-align:center;">Hen√ºz kazanan yok.</td></tr>';
              return;
            }

            data.winners.forEach((w) => {
              // Tarih Formatlama (wonAt alanƒ±)
              let dateDisplay = "-";
              // Backend 'get_winners' i√ßinde tarihi stringe √ßevirip 'wonAt' olarak g√∂nderiyor olabilir.
              // Eƒüer √∂yleyse direkt kullan. Deƒüilse d√ºzelt.
              if (w.wonAt && w.wonAt.includes && w.wonAt.includes(",")) {
                dateDisplay = w.wonAt;
              } else {
                // ≈ûimdilik bo≈üsa veya bozuksa "-" kalsƒ±n
                dateDisplay = w.wonAt || "-";
              }

              tbody.innerHTML += `<tr>
                <td>${dateDisplay}</td>
                <td><b>${w.raffleName}</b></td>
                <td>${w.userName} <br><small style="color:#aaa">${
                w.userEmail
              }</small></td>
                <td><span class="badge badge-success">${w.prize}</span></td>
                <td>${w.rank === 1 ? "ü•á 1. Asil" : w.rank + ". Asil"}</td>
              </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="5">Hen√ºz kazanan yok.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="5">Hata olu≈ütu.</td></tr>';
        }
      }
      // --- KUPON √úRETƒ∞Cƒ∞ (D√úZELTƒ∞LMƒ∞≈û) ---
      async function generateCoupons() {
        const btn = document.querySelector("#modalGenerateCoupon button");
        const originalText = btn.innerText;
        btn.innerText = "√úretiliyor...";
        btn.disabled = true;

        const payload = {
          islem: "generate_coupons",
          count: document.getElementById("genCount").value,
          prefix: document.getElementById("genPrefix").value,
          discount: document.getElementById("genDisc").value,
          type: document.getElementById("genType").value,
          expiry: document.getElementById("genExpiry").value,
        };

        try {
          // üî• D√úZELTME BURADA: getApiUrl() fonksiyonunu √ßaƒüƒ±rƒ±yoruz
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const data = await res.json();
          if (data.success) {
            alert(data.message);
            closeModal("modalGenerateCoupon");
            loadCouponPool();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          console.error(e); // Konsola hatayƒ± yazdƒ±ralƒ±m
          alert("Hata olu≈ütu: " + e.message);
        }

        btn.innerText = originalText;
        btn.disabled = false;
      } // --- KUPON HAVUZU Y√úKLEME (Fƒ∞NAL D√úZELTƒ∞LMƒ∞≈û) ---
      async function loadCouponPool() {
        const tbody = document.querySelector("#table-couponPool tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="6" style="text-align:center;">Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_coupon_pool" }),
          });
          const data = await res.json();

          // KONSOLA BAK: Veriler nasƒ±l geliyor?
          console.log("Kupon Verileri:", data);

          if (data.success) {
            tbody.innerHTML = "";
            data.coupons.forEach((c) => {
              // üî• Kƒ∞Lƒ∞T NOKTA: Backend'den gelen veriye g√∂re kutuyu doldur
              // Eƒüer c.isSynced TRUE ise 'checked' yazƒ±sƒ± eklenir, kutu ye≈üil olur.
              const checkDurumu = c.isSynced === true ? "checked" : "";
              const yaziDurumu =
                c.isSynced === true ? "Eklendi ‚úÖ" : "Bekliyor ‚è≥";

              tbody.innerHTML += `<tr>
                    <td style="font-family:monospace; font-weight:bold">${
                      c.code
                    }</td>
                    <td>${c.discount} ${c.type === "percent" ? "%" : "TL"}</td>
                    <td>${c.expiry || "-"}</td>
                    
                    <td>
                       <div style="display:flex; align-items:center; gap:5px;">
                           <label class="switch" style="margin-bottom:0;">
                              <input type="checkbox" onchange="toggleFaprikaSync('${
                                c.id
                              }', this)" ${checkDurumu}>
                              <span class="slider round"></span>
                           </label>
                           <span style="font-size:11px; color:#666;">${yaziDurumu}</span>
                       </div>
                    </td>

                    <td><span class="badge badge-success">${
                      c.status
                    }</span></td>
                    <td>
                        <button class="btn btn-outline btn-sm" onclick="deleteCoupon('${
                          c.id
                        }')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center;">Kupon yok.</td></tr>';
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="6" style="text-align:center; color:red;">Hata: ' +
            e.message +
            "</td></tr>";
        }
      }
      // --- T√úM KUPONLARI Sƒ∞L ---
      async function deleteAllCoupons() {
        if (!confirm("Dƒ∞KKAT: Havuzdaki T√úM kuponlar silinecek! Emin misiniz?"))
          return;

        // Butonu bulup pasif yapalƒ±m (Y√ºkleniyor efekti)
        const btn = document.querySelector(
          'button[onclick="deleteAllCoupons()"]'
        );
        const originalText = btn.innerHTML;
        btn.innerHTML = "Siliniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "delete_all_coupons" }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            loadCouponPool(); // Listeyi yenile
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerHTML = originalText;
        btn.disabled = false;
      } // --- MAƒûAZA √úR√úNLERƒ∞Nƒ∞ Y√úKLE (DEBUG MODU) ---
      async function loadCouponStore() {
        // ID'yi doƒüru se√ßtiƒüimizden emin olalƒ±m
        const tbody = document.getElementById("store-sortable-list");

        // Eƒüer tbody bulunamazsa (sayfa yapƒ±sƒ± bozuksa) hata ver
        if (!tbody) {
          console.error(
            "HATA: 'store-sortable-list' ID'li element bulunamadƒ±!"
          );
          return;
        }

        tbody.innerHTML =
          '<tr><td colspan="7" style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_store_items" }),
          });
          const data = await res.json();

          console.log("Maƒüaza Verisi:", data); // Konsola veriyi yazdƒ±r

          if (data.success) {
            tbody.innerHTML = "";

            if (!data.items || data.items.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="7" style="text-align:center;">Maƒüazada √ºr√ºn yok.</td></tr>';
              return;
            }

            // Client tarafƒ±nda garanti sƒ±ralama
            data.items.sort((a, b) => (a.order || 9999) - (b.order || 9999));

            data.items.forEach((i) => {
              // Seviye Rozeti
              let lvlBadge =
                '<span class="badge" style="background:#10b981; color:white;">üå± √áaylak</span>';
              const level = (i.minLevel || "").toLowerCase();
              if (level.includes("efsane"))
                lvlBadge =
                  '<span class="badge" style="background:#ef4444; color:white;">üëë Efsane</span>';
              else if (level.includes("≈üampiyon") || level.includes("sampiyon"))
                lvlBadge =
                  '<span class="badge" style="background:#f59e0b; color:white;">ü•á ≈ûampiyon</span>';
              else if (level.includes("usta"))
                lvlBadge =
                  '<span class="badge" style="background:#8b5cf6; color:white;">üèÜ Usta</span>';

              // Satƒ±r HTML
              tbody.innerHTML += `
  <tr data-id="${escapeHtml(i.id)}" style="cursor:move;">
    <td style="color:#aaa; text-align:center;"><i class="fas fa-grip-vertical"></i></td>

    <td style="font-weight:bold;">${escapeHtml(i.title)}</td>

    <td style="color:#e67e22; font-weight:bold;">${i.costXP} XP</td>

    <td>${i.stock}</td>

    <td><small>${escapeHtml(i.type)}</small></td>

    <td>${lvlBadge}</td>

    <td>
      <div style="display:flex; gap:5px;">
        <button class="btn btn-primary btn-sm" onclick="openEditStoreItem('${escapeHtml(
          i.id
        )}')" title="D√ºzenle">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-outline btn-sm" onclick="deleteStoreItem('${escapeHtml(
          i.id
        )}')" title="Sil">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </td>
  </tr>`;
            });

            // üî• SORTABLE.JS'ƒ∞ BA≈ûLAT (Eƒüer k√ºt√ºphane y√ºkl√ºyse)
            if (typeof Sortable !== "undefined") {
              new Sortable(tbody, {
                animation: 150,
                handle: "tr",
                ghostClass: "bg-light",
              });
            } else {
              console.warn("SortableJS k√ºt√ºphanesi y√ºklenmemi≈ü!");
            }
          } else {
            tbody.innerHTML =
              '<tr><td colspan="7" style="text-align:center; color:red;">Y√ºkleme ba≈üarƒ±sƒ±z: ' +
              (data.message || "Bilinmeyen hata") +
              "</td></tr>";
          }
        } catch (e) {
          console.error("Fetch Hatasƒ±:", e);
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align:center; color:red;">Baƒülantƒ± hatasƒ±: ' +
            e.message +
            "</td></tr>";
        }
      } // --- KUPON Sƒ∞LME FONKSƒ∞YONU (D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON) ---
      async function deleteCoupon(id) {
        if (
          !confirm("Bu kuponu kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?")
        )
          return;

        // Tƒ±klanan butonu garantili yakala (ƒ∞kona basƒ±lsa bile butonu bulur)
        const btn = event.target.closest("button") || event.target;
        const oldHTML = btn.innerHTML;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // D√∂nme efekti
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "delete_coupon",
              id: id,
            }),
          });

          const data = await res.json();

          if (data.success) {
            // showToast yerine Alert veya Console kullanƒ±yoruz (Hata vermemesi i√ßin)
            // alert("Kupon Silindi ‚úÖ"); // ƒ∞stersen bunu a√ßabilirsin

            // üî• HATALI OLAN KISIM BURASIYDI, D√úZELTƒ∞LDƒ∞:
            loadCouponPool();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          console.error(e);
          alert("Bir hata olu≈ütu.");
        } finally {
          // Her durumda butonu eski haline getir
          if (btn) {
            btn.innerHTML = oldHTML;
            btn.disabled = false;
          }
        }
      }

      // --- üî• SIRALAMAYI KAYDETME FONKSƒ∞YONU ---
      async function saveStoreOrder() {
        const btn = document.querySelector(
          'button[onclick="saveStoreOrder()"]'
        );
        const originalText = btn ? btn.innerHTML : "Sƒ±ralamayƒ± Kaydet";

        if (btn) {
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
          btn.disabled = true;
        }

        try {
          // 1. Tablodaki sƒ±rayƒ± oku
          const rows = document.querySelectorAll("#store-sortable-list tr");
          const orderedIds = [];
          rows.forEach((row) => {
            const id = row.getAttribute("data-id");
            if (id) orderedIds.push(id);
          });

          if (orderedIds.length === 0) {
            alert("Sƒ±ralanacak √ºr√ºn bulunamadƒ±!");
            if (btn) {
              btn.innerHTML = originalText;
              btn.disabled = false;
            }
            return;
          }

          // üîí 2. G√úVENLƒ∞K KONTROL√ú
          // Tarayƒ±cƒ± hafƒ±zasƒ±nda ≈üifre var mƒ± bakalƒ±m
          let adminPass = localStorage.getItem("admin_secret_temp");

          // Yoksa soralƒ±m
          if (!adminPass) {
            adminPass = prompt("üîë L√ºtfen ƒ∞≈ülem ≈ûifresini Giriniz:");
            if (!adminPass) {
              alert("ƒ∞≈ülem iptal edildi.");
              if (btn) {
                btn.innerHTML = originalText;
                btn.disabled = false;
              }
              return;
            }
            // ≈ûifreyi kaydet (sayfa kapanana kadar hatƒ±rlasƒ±n)
            localStorage.setItem("admin_secret_temp", adminPass);
          }

          // 3. Backend'e g√∂nder
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "update_store_order",
              orderedIds: orderedIds,
              admin_key: adminPass, // ≈ûifreyi paketleyip g√∂nderiyoruz
            }),
          });

          const data = await res.json();

          if (data.success) {
            alert("‚úÖ " + data.message);
            loadCouponStore();
          } else {
            // ≈ûifre yanlƒ±≈üsa hafƒ±zadan silelim ki tekrar sorsun
            if (data.message.includes("YETKƒ∞Sƒ∞Z")) {
              localStorage.removeItem("admin_secret_temp");
              alert("‚õî HATA: Girdiƒüiniz ≈üifre yanlƒ±≈ü!");
            } else {
              alert("Hata: " + data.message);
            }
          }
        } catch (e) {
          console.error(e);
          alert("Baƒülantƒ± hatasƒ± olu≈ütu.");
        } finally {
          if (btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }
        }
      }
      // --- TEST SATI≈ûI (ADMƒ∞N KENDƒ∞NE ALIR) ---
      async function testBuyItem(id, title) {
        const email = prompt(
          `"${title}" √ºr√ºn√ºn√º test etmek i√ßin hangi E-posta hesabƒ±ndan XP d√º≈ü√ºls√ºn?`
        );
        if (!email) return;

        if (
          !confirm(
            `${email} hesabƒ±ndan puan d√º≈ü√ºlecek ve stok azalacak. Onaylƒ±yor musun?`
          )
        )
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "buy_store_item",
              email: email,
              itemId: id,
            }),
          });
          const data = await res.json();
          alert(data.message);
          loadCouponStore(); // Stoƒüu g√ºncellemek i√ßin listeyi yenile
        } catch (e) {
          alert("Hata olu≈ütu.");
        }
      }
      // --- TEK KUPON EKLEME ---
      async function addCoupon() {
        const code = document.getElementById("cpCode").value;
        const discount = document.getElementById("cpDisc").value;
        const type = document.getElementById("cpType").value;
        const expiry = document.getElementById("cpExpiry").value;

        if (!code || !discount) return alert("Kod ve indirim deƒüeri giriniz.");

        const btn = document.querySelector("#modalCoupon button");
        btn.innerText = "Ekleniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "add_coupon",
              code: code,
              discount: discount,
              type: type,
              expiry: expiry,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            closeModal("modalCoupon");
            loadCouponPool();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerText = "Kaydet";
        btn.disabled = false;
      } // 2. YENƒ∞ √úR√úN EKLE (Seviye Bilgisiyle)
      async function addStoreItem() {
        const payload = {
          islem: "add_store_item",
          title: document.getElementById("stTitle").value,
          description: document.getElementById("stDesc").value,
          cost: document.getElementById("stCost").value,
          stock: document.getElementById("stStock").value,
          type: document.getElementById("stType").value,
          kupon_kodu: document.getElementById("stKuponKodu").value,
          minLevel: document.getElementById("stLevel").value, // üî• YENƒ∞ VERƒ∞
        };

        if (!payload.title || !payload.cost)
          return alert("Ba≈ülƒ±k ve Puan giriniz.");

        const btn = document.querySelector("#modalStoreItem button");
        btn.innerText = "Ekleniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            closeModal("modalStoreItem");
            loadCouponStore();
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerText = "√úr√ºn√º Olu≈ütur";
        btn.disabled = false;
      }
      // --- MAƒûAZA √úR√úN√úN√ú Sƒ∞L ---
      async function deleteStoreItem(id) {
        if (!confirm("√úr√ºn maƒüazadan kaldƒ±rƒ±lsƒ±n mƒ±?")) return;

        // Butonu bul ve "Siliniyor..." yaz (G√∂rsel geri bildirim)
        const btn = document.querySelector(
          `button[onclick="deleteStoreItem('${id}')"]`
        );
        if (btn) {
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          btn.disabled = true;
        }

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "delete_store_item", id: id }),
          });

          const data = await res.json();
          if (data.success) {
            // Ba≈üarƒ±lƒ±ysa tabloyu yeniden y√ºkle
            loadCouponStore();
          } else {
            alert("Hata: " + data.message);
            if (btn) {
              btn.innerHTML = '<i class="fas fa-trash"></i>';
              btn.disabled = false;
            }
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
          if (btn) {
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.disabled = false;
          }
        }
      }
      // --- #11 REFERANSLAR ---
      async function loadReferrals() {
        const tbody = document.querySelector("#table-referrals tbody");
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="4">Y√ºkleniyor...</td></tr>';
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_referrals" }),
          });
          const data = await res.json();
          if (data.success) {
            tbody.innerHTML = "";
            data.list.forEach((r) => {
              tbody.innerHTML += `<tr>
<td><b>${r.inviter}</b></td>
<td>${r.invitee}</td>
<td>${r.date}</td>
<td><span class="badge badge-success">+${r.earned} XP</span></td>
          </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="4">Veri yok.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="4">Hata olu≈ütu.</td></tr>';
        }
      }
      // --- #6 GERƒ∞ Bƒ∞LDƒ∞Rƒ∞M Lƒ∞STELEME (DEƒûERLENDƒ∞RME DAHƒ∞L) ---
      async function loadFeedbacks() {
        const tbody = document.querySelector("#table-feedback tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_feedbacks" }),
          });
          const data = await res.json();

          if (data.success) {
            tbody.innerHTML = "";

            if (data.list.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="5">Hen√ºz talep veya deƒüerlendirme yok.</td></tr>';
              return;
            }

            data.list.forEach((f) => {
              // Durum Rozeti
              const isAnswered =
                f.status === "answered" || f.status === "üü¢ Cevaplandƒ±";
              const statusBadge = isAnswered
                ? '<span class="badge badge-success"><i class="fas fa-check"></i> Cevaplandƒ±</span>'
                : '<span class="badge badge-danger"><i class="fas fa-clock"></i> Bekliyor</span>';

              // T√ºr Ayrƒ±mƒ± (Deƒüerlendirme mi Destek mi?)
              let typeLabel = '<span class="badge badge-info">üí¨ Destek</span>';
              if (
                f.type === "evaluation" ||
                f.subject.includes("Deƒüerlendirme")
              ) {
                typeLabel =
                  '<span class="badge badge-warning">‚≠ê Deƒüerlendirme</span>';
              }

              // Mesaj Kƒ±saltma Yok (Tamamƒ±nƒ± g√∂ster)
              const msgContent = f.message || "";
              const ticketNum = f.ticketId || "#";

              // G√ºvenli metin
              const safeSub = (f.subject || "").replace(/'/g, "");
              const safeMsg = msgContent.replace(/'/g, "");

              tbody.innerHTML += `
              <tr style="${!isAnswered ? "background-color:#fff5f5" : ""}">
                <td>
                  <span style="font-weight:bold; font-family:monospace; color:#64748b">${ticketNum}</span><br>
                  <span style="font-size:0.8rem; color:#999">${f.date}</span>
                </td>
                <td>
                  <b>${f.email}</b><br>
                  <small>${f.phone}</small>
                </td>
                <td>
                  <div style="margin-bottom:4px;">${typeLabel}</div>
                  <div style="font-weight:600; color:#333">${f.subject}</div>
                  <div style="font-size:0.9rem; color:#333; margin-top:5px; white-space:pre-wrap;">${msgContent}</div>
                  ${
                    f.adminReply
                      ? '<div style="color:green; font-size:0.75rem; margin-top:2px;"><i class="fas fa-reply"></i> Yanƒ±tlandƒ±</div>'
                      : ""
                  }
                </td>
                <td>${statusBadge}</td>
                <td>
                  <button class="btn btn-primary btn-sm" 
                  onclick="openReplyModal('${
                    f.id
                  }', '${ticketNum}', '${safeSub}', '${safeMsg}')">
                  <i class="fas fa-paper-plane"></i> Cevapla
                  </button>
                </td>
              </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="5">Veri √ßekilemedi: ' +
              (data.message || "Bilinmeyen hata") +
              "</td></tr>";
          }
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            '<tr><td colspan="5">Baƒülantƒ± hatasƒ±: ' + e.message + "</td></tr>";
        }
      }
      // Sol Men√ºdeki "Geri Bildirim" yazƒ±sƒ±nƒ±n yanƒ±na sayƒ± ekler
      function updateSidebarBadge(count) {
        const menuLinks = document.querySelectorAll(".nav-item");
        menuLinks.forEach((link) => {
          if (link.innerText.includes("Geri Bildirim")) {
            if (count > 0) {
              link.innerHTML = `<i class="fas fa-headset"></i> Geri Bildirim <span class="badge badge-danger" style="margin-left:auto">${count}</span>`;
            } else {
              link.innerHTML = `<i class="fas fa-headset"></i> Geri Bildirim`;
            }
          }
        });
      }

      // --- CEVAP PENCERESƒ∞Nƒ∞ A√á ---
      function openReplyModal(docId, ticketId, subject, message) {
        // Verileri kutucuklara doldur
        document.getElementById("replyDocId").value = docId;
        document.getElementById("replySubject").value =
          ticketId + " - " + subject; // Ticket ID ba≈ülƒ±kta g√∂r√ºns√ºn
        document.getElementById("replyUserMsg").value = message;
        document.getElementById("replyAdminMsg").value = ""; // Cevap kutusunu temizle

        // Modalƒ± A√ß
        openModal("modalReply");
      }

      // --- CEVABI G√ñNDER ---
      async function sendReply() {
        const id = document.getElementById("replyDocId").value;
        const msg = document.getElementById("replyAdminMsg").value;

        if (!msg.trim()) return alert("L√ºtfen bir cevap yazƒ±n.");

        // Butonu kilitle
        const btn = document.querySelector("#modalReply button");
        btn.innerText = "G√∂nderiliyor...";
        btn.disabled = true;

        try {
          await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "reply_feedback",
              docId: id,
              replyMessage: msg,
            }),
          });

          alert("‚úÖ Cevap ba≈üarƒ±yla kaydedildi!");
          closeModal("modalReply");
          loadFeedbacks(); // Listeyi yenile ki durum "Cevaplandƒ±" olsun
        } catch (e) {
          alert("Hata: " + e.message);
        }

        // Butonu a√ß
        btn.innerText = "Yanƒ±tƒ± G√∂nder";
        btn.disabled = false;
      }

      async function sendReply() {
        const id = document.getElementById("replyDocId").value;
        const msg = document.getElementById("replyAdminMsg").value;
        if (!msg) return alert("Cevap yazƒ±n.");

        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            islem: "reply_feedback",
            docId: id,
            replyMessage: msg,
          }),
        });
        alert("Cevaplandƒ±!");
        closeModal("modalReply");
        loadFeedbacks();
      }

      // --- #7 Bƒ∞LDƒ∞Rƒ∞MLER (TARƒ∞H FORMATI Fƒ∞X) ---
      async function loadNotifications() {
        const tbody = document.querySelector("#table-notifications tbody");
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="2">Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_notifications" }),
          });
          const data = await res.json();

          if (data.success) {
            document.getElementById("sub-count").innerText = data.count || 0;
            tbody.innerHTML = "";

            data.list.forEach((n) => {
              // --- üî• TARƒ∞H D√úZELTME MOTORU ---
              let dateDisplay = "-";

              // 1. Durum: Firebase Timestamp (_seconds) gelirse
              if (n.createdAt && n.createdAt._seconds) {
                dateDisplay = new Date(
                  n.createdAt._seconds * 1000
                ).toLocaleString("tr-TR");
              }
              // 2. Durum: Senin veritabanƒ±ndaki gibi String ("2025-11-11T...") gelirse
              else if (n.createdAt && typeof n.createdAt === "string") {
                // T harfini bo≈ülukla deƒüi≈ütir, saniyeden sonrasƒ±nƒ± (noktayƒ±) at
                dateDisplay = n.createdAt.replace("T", " ").split(".")[0];
              }

              tbody.innerHTML += `<tr>
<td style="font-family:monospace; color:#64748b;">${dateDisplay}</td>
<td><b>${n.email}</b></td>
          </tr>`;
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="2">Liste bo≈ü.</td></tr>';
          }
        } catch (e) {
          tbody.innerHTML =
            '<tr><td colspan="2">Hata: ' + e.message + "</td></tr>";
        }
      }

      async function sendAnnouncement() {
        const subj = document.getElementById("annSubject").value;
        const cont = document.getElementById("annContent").value;
        if (!subj || !cont) return alert("Doldurunuz.");

        if (!confirm("Bu duyuru listedeki HERKESE g√∂nderilecek. Emin misin?"))
          return;

        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            islem: "send_bulk_announcement",
            subject: subj,
            content: cont,
          }),
        });
        alert("G√∂nderildi!");
        closeModal("modalAnnouncement");
      }
      // --- Sƒ∞PARƒ∞≈û Sƒ∞M√úLASYONU ---
      async function simulateOrder() {
        const email = prompt("Sipari≈üi veren M√º≈üteri E-postasƒ±:");
        if (!email) return;

        const amount = prompt("Sipari≈ü Tutarƒ± (TL):", "1500");
        if (!amount) return;

        if (
          !confirm(
            `${email} i√ßin ${amount} TL deƒüerinde sipari≈ü i≈ülenecek.\n\n- Puan verilecek\n- %5 Referans Primi daƒüƒ±tƒ±lacak\n- %2 Havuza eklenecek\n\nOnaylƒ±yor musun?`
          )
        )
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "process_faprika_order",
              email: email,
              total_price: amount,
              order_id: "TEST-" + Math.floor(Math.random() * 10000),
            }),
          });
          const data = await res.json();
          alert(data.message);
          // Dashboard'u yenile ki puanlarƒ± g√∂relim
          loadUsers();
          loadDashboard();
        } catch (e) {
          alert("Hata: " + e.message);
        }
      }
      // --- LOGGER (HATA VE ƒ∞≈ûLEM KAYITLARI) - Fƒ∞NAL VERSƒ∞YON ---
      async function loadErrorLogs() {
        const tbody = document.querySelector("#table-logger tbody");
        if (!tbody) return;

        tbody.innerHTML =
          '<tr><td colspan="3"><i class="fas fa-spinner fa-spin"></i> Y√ºkleniyor...</td></tr>';

        try {
          // Backend'e "get_logger" emri g√∂nderiyoruz
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_logger" }),
          });
          const data = await res.json();

          if (data.success && data.logs.length > 0) {
            tbody.innerHTML = "";

            data.logs.forEach((log) => {
              // Backend'den artƒ±k 'message' adƒ±yla geliyor.
              // Ne olur ne olmaz diye 'action'ƒ± da kontrol edelim.
              const mesaj = log.message || log.action || "ƒ∞≈ülem";
              const detay = log.details || "-";
              const tarih = log.tarih || "-";

              // Renklendirme Mantƒ±ƒüƒ± (Badge Rengi)
              let badgeColor = "badge-info"; // Varsayƒ±lan mavi
              const msgUpper = mesaj.toUpperCase();

              if (
                msgUpper.includes("HATA") ||
                msgUpper.includes("ERROR") ||
                msgUpper.includes("FAIL")
              ) {
                badgeColor = "badge-danger"; // Hata ise Kƒ±rmƒ±zƒ±
              } else if (
                msgUpper.includes("ALTIN") ||
                msgUpper.includes("KAZAN")
              ) {
                badgeColor = "badge-warning"; // √ñd√ºl ise Sarƒ±
              } else if (
                msgUpper.includes("BA≈ûARILI") ||
                msgUpper.includes("SUCCESS")
              ) {
                badgeColor = "badge-success"; // Ba≈üarƒ± ise Ye≈üil
              }

              tbody.innerHTML += `<tr>
<td style="white-space:nowrap; font-size:0.85rem; color:#64748b;">${tarih}</td>
<td><span class="badge ${badgeColor}">${mesaj}</span></td>
<td style="font-size:0.85rem; color:#333;">${detay}</td>
          </tr>`;
            });
          } else {
            tbody.innerHTML =
              '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">Kayƒ±t bulunamadƒ±.</td></tr>';
          }
        } catch (e) {
          console.error("Logger hatasƒ±:", e);
          tbody.innerHTML =
            '<tr><td colspan="3" style="color:red;">Veri √ßekilemedi: ' +
            e.message +
            "</td></tr>";
        }
      }
      // --- D√úZELTME 1: KULLANICI D√úZENLEME KISAYOLU ---
      function openGivePointModal(email) {
        document.getElementById("inputPointEmail").value = email;
        openModal("modalGivePoint");
      }

      // --- D√úZELTME 2: EFSANE HAVUZUNA FON EKLEME ---
      async function manualAddPool() {
        const amount = prompt(
          "Havuza ne kadar eklemek istiyorsun? (√áƒ±karmak i√ßin ba≈üƒ±na - koyabilirsin):",
          "100"
        );
        if (!amount) return;

        const val = parseFloat(amount);
        if (isNaN(val)) return alert("Sayƒ± giriniz.");

        if (!confirm(`${val} TL tutarƒ±nda i≈ülem yapƒ±lacak. Onaylƒ±yor musun?`))
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "admin_add_pool_funds",
              amount: val,
              adminEmail: "Patron",
            }),
          });
          const data = await res.json();

          if (data.success) {
            alert(data.message);
            loadDailyCodes(); // Havuz tutarƒ±nƒ± yenile
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }
      }
      // --- ≈ûƒ∞FRE PLANLAMA ---
      async function scheduleCodes() {
        const date = document.getElementById("schStartDate").value;
        const text = document.getElementById("schCodes").value;

        if (!date || !text.trim()) return alert("Tarih ve ≈üifreleri giriniz.");

        if (
          !confirm(
            "Bu ≈üifreler se√ßilen tarihten itibaren g√ºn g√ºn i≈ülenecek. Onaylƒ±yor musun?"
          )
        )
          return;

        const btn = document.querySelector("#modalScheduleCodes button");
        btn.innerText = "ƒ∞≈üleniyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "bulk_schedule_codes",
              startDate: date,
              codesText: text,
            }),
          });
          const data = await res.json();

          if (data.success) {
            alert(data.message);
            closeModal("modalScheduleCodes");
            document.getElementById("schCodes").value = ""; // Temizle
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerText = "üíæ Takvimi Kaydet";
        btn.disabled = false;
      }
      // --- ≈ûƒ∞FRE TAKVƒ∞Mƒ∞Nƒ∞ Y√úKLE ---
      async function loadScheduledCodes() {
        const tbody = document.querySelector("#table-scheduledCodes tbody");
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="4">Y√ºkleniyor...</td></tr>';

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_scheduled_codes" }),
          });
          const data = await res.json();

          if (data.success) {
            tbody.innerHTML = "";
            if (data.list.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="4">Planlanmƒ±≈ü ≈üifre yok.</td></tr>';
            }

            data.list.forEach((item) => {
              let badgeClass = "badge-info";
              let statusText = "Gelecek";

              if (item.status === "past") {
                badgeClass = "badge-danger";
                statusText = "Ge√ßmi≈ü";
              } // Rengi d√ºzelttim (Ge√ßmi≈üse kƒ±rmƒ±zƒ±/soluk)
              if (item.status === "today") {
                badgeClass = "badge-success";
                statusText = "BUG√úN AKTƒ∞F";
              }

              tbody.innerHTML += `<tr>
<td style="font-family:monospace;">${item.date}</td>
<td><b>${item.code}</b></td>
<td><span class="badge ${badgeClass}">${statusText}</span></td>
<td>
<button class="btn btn-outline btn-sm" onclick="deleteScheduledCode('${item.date}')" title="Sil">
<i class="fas fa-trash" style="color:var(--danger)"></i>
          </button>
          </td>
          </tr>`;
            });
          }
        } catch (e) {
          tbody.innerHTML = '<tr><td colspan="4">Hata.</td></tr>';
        }
      }

      // --- ≈ûƒ∞FRE Sƒ∞L ---
      async function deleteScheduledCode(date) {
        if (!confirm(`${date} tarihli ≈üifreyi silmek istiyor musun?`)) return;

        await fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "delete_scheduled_code", date: date }),
        });

        loadScheduledCodes(); // Listeyi yenile
      }
      // --- DOƒûUM G√úN√ú TESTƒ∞ ---
      async function testBirthday(email) {
        const date = prompt(
          `${email} i√ßin doƒüum tarihi girin (G√ºn.Ay.Yƒ±l):`,
          "01.01.1990"
        );
        if (!date) return;

        if (
          !confirm(
            `${email} hesabƒ±na doƒüum tarihi i≈ülenecek ve √∂d√ºl verilecek. Onaylƒ±yor musun?`
          )
        )
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "register_birthday",
              email: email,
              birthDate: date,
            }),
          });
          const data = await res.json();

          console.log("D√∂nen Veri:", data); // Konsola yazdƒ±ralƒ±m ki g√∂relim

          if (data.message) {
            alert(data.message);
          } else {
            alert("ƒ∞≈ülem sonucu: " + JSON.stringify(data));
          }

          loadUsers();
        } catch (e) {
          alert("Hata olu≈ütu: " + e);
        }
      }
      function checkTaskType() {
        const type = document.getElementById("taskType").value;
        const linkInput = document.getElementById("taskLink");

        if (type === "instagram") {
          linkInput.value = "https://instagram.com/modumnetco";
        } else {
          linkInput.value = "";
        }
      }

      // --- Gƒ∞Rƒ∞≈û / √áIKI≈û Sƒ∞STEMƒ∞ ---

      // Sayfa a√ßƒ±lƒ±nca kontrol et
      window.addEventListener("DOMContentLoaded", () => {
        const isLogged = localStorage.getItem("modum_admin_logged");
        if (isLogged === "true") {
          showPanel(); // Zaten giri≈ü yapmƒ±≈üsa paneli a√ß
        }
      });

      function showPanel() {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("app-container").style.display = "flex";
        loadDashboard(); // Verileri √ßekmeye ba≈üla
      } // index.html i√ßindeki doLogin fonksiyonu B√ñYLE OLMALI:
      async function doLogin() {
        const email = document.getElementById("loginEmail").value;
        const pass = document.getElementById("loginPass").value;
        const btn = document.querySelector(".login-box button");
        const msg = document.getElementById("loginMsg");

        if (!email || !pass) {
          msg.innerText = "Bilgileri giriniz.";
          return;
        }

        btn.innerText = "Kontrol Ediliyor...";
        btn.disabled = true;

        try {
          // ≈ûifreyi burada KONTROL ETMƒ∞YORUZ. Backend'e g√∂nderiyoruz.
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "admin_login",
              email: email,
              password: pass, // ≈ûifreyi olduƒüu gibi g√∂nder
            }),
          });
          const data = await res.json();

          if (data.success) {
            localStorage.setItem("modum_admin_logged", "true");
            localStorage.setItem("modum_admin_pass", pass);
            showPanel();
          } else {
            msg.innerText = data.message;
            btn.innerText = "Gƒ∞Rƒ∞≈û YAP";
            btn.disabled = false;
          }
        } catch (e) {
          msg.innerText = "Baƒülantƒ± hatasƒ±!";
          btn.innerText = "Gƒ∞Rƒ∞≈û YAP";
          btn.disabled = false;
        }
      }
      // --- YENƒ∞: √áEKƒ∞Lƒ∞≈û TARƒ∞Hƒ∞Nƒ∞ G√úNCELLEME ---
      async function editRaffleDate(id, currentDate) {
        // ≈ûu anki tarihi varsayƒ±lan olarak g√∂ster
        // Kullanƒ±cƒ±dan yeni tarih iste (Format: YYYY-MM-DDTHH:mm)
        // √ñrnek: 2025-12-13T23:59
        const yeniTarih = prompt(
          "Yeni Biti≈ü Tarihini Girin (Yƒ±l-Ay-G√ºnTsaat:dakika):",
          "2025-12-13T23:59"
        );

        if (!yeniTarih) return; // ƒ∞ptal ederse dur

        // Basit format kontrol√º
        if (!yeniTarih.includes("T") || !yeniTarih.includes("-")) {
          alert("L√ºtfen formatƒ± doƒüru girin: 2025-12-13T23:59");
          return;
        }

        if (!confirm(yeniTarih + " olarak g√ºncellenecek. Onaylƒ±yor musun?"))
          return;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "update_raffle_date",
              id: id,
              newDate: yeniTarih,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert(data.message);
            loadRaffles(); // Tabloyu yenile
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu: " + e);
        }
      } // --- üî• Fƒ∞NAL √á√ñZ√úM: GARANTƒ∞Lƒ∞ A√áILAN VE KAPANAN MODAL ---
      function forceOpenRaffleModal() {
        // 1. √ñnce eski veya takƒ±lmƒ±≈ü bir pencere varsa temizle
        const old = document.getElementById("modalRaffleFixed");
        if (old) old.remove();

        // 2. HTML ƒ∞√ßeriƒüi (Temiz ve ID'li)
        const htmlContent = `
    <div id="modalRaffleFixed" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:2147483647; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
      <div style="background:white; width:90%; max-width:500px; padding:30px; border-radius:15px; box-shadow:0 0 50px rgba(0,0,0,0.5); position:relative; font-family:'Inter',sans-serif;">
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <h3 style="margin:0; color:#333;">‚ú® Yeni √áekili≈ü Ba≈ülat</h3>
          
          <span id="btnRaffleClose" style="cursor:pointer; font-size:2rem; line-height:0.5; color:#ff4444; padding:10px;">&times;</span>
        
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px; color:#555;">√áekili≈ü Adƒ±</label>
            <input type="text" id="rafName" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;" placeholder="√ñrn: Haftalƒ±k 1000 TL √ñd√ºl√º">
        </div>
        
        <div style="margin-bottom:15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px; color:#555;">Biti≈ü Tarihi</label>
            <input type="datetime-local" id="rafDate" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;">
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px; color:#555;">√ñd√ºl Tanƒ±mƒ±</label>
            <input type="text" id="rafReward" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;" placeholder="√ñrn: 1000 Puan">
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block; font-weight:bold; margin-bottom:5px; color:#555;">Kazanan Sayƒ±sƒ±</label>
            <input type="number" id="rafWinners" value="1" style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box;">
        </div>

        <button id="btnCreateRaffle" onclick="createRaffle()" style="width:100%; padding:15px; background:#4361ee; color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px; cursor:pointer; transition:0.2s;">
          üöÄ √áekili≈üi Olu≈ütur
        </button>

      </div>
    </div>
  `;

        // 3. Sayfaya Yapƒ±≈ütƒ±r
        const div = document.createElement("div");
        div.innerHTML = htmlContent;
        document.body.appendChild(div);

        // 4. üî• Sƒ∞Hƒ∞RLƒ∞ DOKUNU≈û: KAPATMA BUTONUNA "ZORLA" G√ñREV VERƒ∞YORUZ
        // HTML olu≈ütuktan hemen sonra butonu bulup olayƒ± dinliyoruz.
        setTimeout(() => {
          const closeBtn = document.getElementById("btnRaffleClose");
          if (closeBtn) {
            closeBtn.addEventListener("click", function () {
              const modal = document.getElementById("modalRaffleFixed");
              if (modal) modal.remove();
            });
          }
        }, 100);
      }
      // --- HEADER BAKIM MODU Y√ñNETƒ∞Mƒ∞ (GELƒ∞≈ûTƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON) ---

      // 1. Sayfa A√ßƒ±lƒ±nca Durumu Kontrol Et
      async function checkHeaderMaintStatus() {
        try {
          console.log("üîç Bakƒ±m durumu kontrol ediliyor...");
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ islem: "get_settings" }),
          });
          const data = await res.json();
          console.log("üì° Sunucudan Gelen Veri:", data);

          // Gelen veri "true" (yazƒ±) da olsa, true (mantƒ±ksal) da olsa kabul et
          let isMaint = false;
          if (data.settings && data.settings.maintenance_mode) {
            const val = data.settings.maintenance_mode;
            // Hem string "true" hem boolean true kontrol√º
            if (val === "true" || val === true) isMaint = true;
          }
          // ... (Mevcut bakƒ±m modu kodlarƒ± burada) ...

          // üî• TEMA Bƒ∞LGƒ∞Sƒ∞Nƒ∞ DE Y√úKLE
          if (data.settings && data.settings.active_theme) {
            const themeSelect = document.getElementById("set_active_theme");
            if (themeSelect) themeSelect.value = data.settings.active_theme;
          }

          updateHeaderUI(isMaint);
        } catch (e) {
          console.error("üö® Bakƒ±m durumu hatasƒ±:", e);
        }
      }

      // 2. Butona Basƒ±nca √áalƒ±≈üacak Fonksiyon
      async function toggleMaintenanceHeader() {
        const toggle = document.getElementById("header_maint_toggle");
        const isMaintenance = toggle.checked; // True ise Bakƒ±ma alƒ±yoruz

        console.log("üñ±Ô∏è Butona basƒ±ldƒ±. ƒ∞stenen Durum:", isMaintenance);

        // √ñnce g√∂r√ºnt√ºy√º g√ºncelle (Kullanƒ±cƒ± beklemesin)
        updateHeaderUI(isMaintenance);

        // Sunucuya Kaydet
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "set_maintenance",
              status: isMaintenance ? "true" : "false", // String olarak g√∂nderiyoruz
            }),
          });
          const data = await res.json();

          if (data.success) {
            console.log("‚úÖ Sunucuya ba≈üarƒ±yla kaydedildi.");
          } else {
            console.error("‚ùå Sunucu hatasƒ±:", data.message);
            alert("Hata: Ayar kaydedilemedi! (" + data.message + ")");
            // Hata varsa butonu geri √ßevir
            toggle.checked = !isMaintenance;
            updateHeaderUI(!isMaintenance);
          }
        } catch (e) {
          console.error("üö® Baƒülantƒ± hatasƒ±:", e);
          alert("Sunucuyla baƒülantƒ± kurulamadƒ±!");
          toggle.checked = !isMaintenance;
          updateHeaderUI(!isMaintenance);
        }
      }

      // 3. G√∂r√ºn√ºm√º G√ºncelleyen Yardƒ±mcƒ± Fonksiyon
      function updateHeaderUI(isMaint) {
        const toggle = document.getElementById("header_maint_toggle");
        const label = document.getElementById("maint_label");

        // Eƒüer elemanlar sayfada yoksa hata vermesin
        if (!toggle || !label) return;

        toggle.checked = isMaint;

        if (isMaint) {
          label.innerHTML = "üî¥ BAKIM MODU";
          label.style.color = "#ef4444";
          label.style.fontWeight = "bold";
        } else {
          label.innerHTML = "üü¢ Sƒ∞TE AKTƒ∞F";
          label.style.color = "#10b981";
          label.style.fontWeight = "bold";
        }
      }

      // Sayfa y√ºklenince √ßalƒ±≈ütƒ±r
      document.addEventListener("DOMContentLoaded", function () {
        checkHeaderMaintStatus();
      });

      // 3. G√∂r√ºn√ºm√º G√ºncelleyen Yardƒ±mcƒ± Fonksiyon
      function updateHeaderUI(isMaintenance) {
        const toggle = document.getElementById("header_maint_toggle");
        const label = document.getElementById("maint_label");

        toggle.checked = isMaintenance;

        if (isMaintenance) {
          label.innerHTML = "üî¥ BAKIM MODU";
          label.style.color = "#ef4444"; // Kƒ±rmƒ±zƒ±
        } else {
          label.innerHTML = "üü¢ Sƒ∞TE AKTƒ∞F";
          label.style.color = "#10b981"; // Ye≈üil
        }
      }

      // 4. Sayfa Y√ºklendiƒüinde Bunu √áalƒ±≈ütƒ±r
      // Mevcut window.onload veya init fonksiyonunun i√ßine ≈üunu ekle:
      // checkHeaderMaintStatus();

      // Eƒüer nereye ekleyeceƒüini bilemezsen, direkt buraya yaz √ßalƒ±≈üƒ±r:
      document.addEventListener("DOMContentLoaded", function () {
        checkHeaderMaintStatus();
      });

      function doLogout() {
        localStorage.removeItem("modum_admin_logged");
        location.reload(); // Sayfayƒ± yenile, giri≈ü ekranƒ± gelir
      } // --- KUPON ONAY FONKSƒ∞YONU (TAMƒ∞R EDƒ∞LDƒ∞ ‚úÖ) ---
      async function toggleFaprikaSync(id, element) {
        const isChecked = element.checked; // A√ßƒ±k mƒ± Kapalƒ± mƒ±?

        // Yanƒ±ndaki yazƒ±yƒ± bul (Eklendi/Bekliyor yazƒ±sƒ±)
        const labelSpan = element.parentElement.nextElementSibling;
        if (labelSpan) labelSpan.innerText = "Kaydediliyor...";

        try {
          // üî• D√úZELTME: fetchApi yerine senin sistemindeki standart fetch yapƒ±sƒ±nƒ± kullandƒ±k.
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "toggle_coupon_sync",
              id: id,
              status: isChecked,
            }),
          });

          const result = await res.json();

          if (result.success) {
            console.log(
              "‚úÖ Durum g√ºncellendi: " + (isChecked ? "Onaylƒ±" : "Onaysƒ±z")
            );
            // G√∂rsel olarak yazƒ±yƒ± hemen g√ºncelle (F5 yapmaya gerek kalmadan g√∂r)
            if (labelSpan)
              labelSpan.innerText = isChecked ? "Eklendi ‚úÖ" : "Bekliyor ‚è≥";
          } else {
            alert("Hata: " + result.message);
            element.checked = !isChecked; // Hata varsa eski haline getir
            if (labelSpan)
              labelSpan.innerText = !isChecked ? "Eklendi ‚úÖ" : "Bekliyor ‚è≥";
          }
        } catch (e) {
          console.error(e);
          alert("Baƒülantƒ± hatasƒ±!");
          element.checked = !isChecked; // Eski haline getir
        }
      }
      // --- üî• Sƒ∞Hƒ∞RLƒ∞ OTOMATƒ∞K G√úVENLƒ∞K KODU ---
      // Bu kod, t√ºm i≈ülemlere senin giri≈ü yaparken yazdƒ±ƒüƒ±n ≈üifreyi ekler.
      (function () {
        const originalFetch = window.fetch;
        window.fetch = async function (url, options) {
          if (options && options.method === "POST" && options.body) {
            try {
              let bodyObj = JSON.parse(options.body);
              const myPass = localStorage.getItem("modum_admin_pass");
              if (myPass) {
                bodyObj.adminToken = myPass;
                options.body = JSON.stringify(bodyObj);
              }
            } catch (e) {}
          }
          return originalFetch(url, options);
        };
      })();
      // --- OTO-Pƒ∞LOT PENCERESƒ∞Nƒ∞ A√á ---
      async function openAutoRaffleModal() {
        const btn = event.target;
        btn.innerHTML = "...";

        try {
          const res = await fetchApi("get_auto_raffle_settings");
          if (res.success) {
            const s = res.settings;

            if (s.daily) {
              document.getElementById("ar_daily_active").checked =
                s.daily.active;
              document.getElementById("ar_daily_date").value = s.daily.nextRun;
              document.getElementById("ar_daily_amount").value =
                s.daily.rewardAmount;
              document.getElementById("ar_daily_winners").value =
                s.daily.winnerCount;
            }
            if (s.weekly) {
              document.getElementById("ar_weekly_active").checked =
                s.weekly.active;
              document.getElementById("ar_weekly_date").value =
                s.weekly.nextRun;
              document.getElementById("ar_weekly_amount").value =
                s.weekly.rewardAmount;
              document.getElementById("ar_weekly_winners").value =
                s.weekly.winnerCount;
            }
            if (s.monthly) {
              document.getElementById("ar_monthly_active").checked =
                s.monthly.active;
              document.getElementById("ar_monthly_date").value =
                s.monthly.nextRun;
              document.getElementById("ar_monthly_amount").value =
                s.monthly.rewardAmount;
              document.getElementById("ar_monthly_winners").value =
                s.monthly.winnerCount;
            }
            openModal("modalAutoRaffle");
          }
        } catch (e) {
          alert("Hata: " + e);
        }
        btn.innerHTML = '<i class="fas fa-robot"></i> Oto-Pilot Ba≈ülat';
      }

      // --- AYARLARI KAYDET ---
      async function saveAutoRaffleSettings() {
        const settings = {
          daily: {
            active: document.getElementById("ar_daily_active").checked,
            nextRun: document.getElementById("ar_daily_date").value,
            rewardAmount: document.getElementById("ar_daily_amount").value,
            winnerCount: document.getElementById("ar_daily_winners").value,
          },
          weekly: {
            active: document.getElementById("ar_weekly_active").checked,
            nextRun: document.getElementById("ar_weekly_date").value,
            rewardAmount: document.getElementById("ar_weekly_amount").value,
            winnerCount: document.getElementById("ar_weekly_winners").value,
          },
          monthly: {
            active: document.getElementById("ar_monthly_active").checked,
            nextRun: document.getElementById("ar_monthly_date").value,
            rewardAmount: document.getElementById("ar_monthly_amount").value,
            winnerCount: document.getElementById("ar_monthly_winners").value,
          },
        };

        if (confirm("Ayarlar kaydedilsin mi?")) {
          const res = await fetchApi("save_auto_raffle_settings", { settings });
          if (res.success) {
            alert("‚úÖ Sistem Ayarlandƒ±! Robot artƒ±k tarihleri takip edecek.");
            closeModal("modalAutoRaffle");
          }
        }
      }
      // ANKETLERƒ∞ Y√úKLE (FINAL - HATA GE√áƒ∞RMEZ VERSƒ∞YON üõ°Ô∏è)
      async function loadSurveys() {
        const tbody = document.querySelector("#table-surveys tbody");
        if (!tbody) {
          console.error("HATA: Tablo bulunamadƒ±!");
          return;
        }

        tbody.innerHTML =
          "<tr><td colspan='5' style='text-align:center;'>Veriler Sunucudan √áekiliyor...</td></tr>";

        try {
          // Veriyi √ßek
          const res = await fetchApi("get_admin_surveys");
          console.log("Sunucudan Gelen Ham Veri:", res); // F12 konsolunda g√∂rebilirsin

          if (res.success) {
            tbody.innerHTML = "";

            // Liste bo≈üsa
            if (!res.list || res.list.length === 0) {
              tbody.innerHTML =
                "<tr><td colspan='5' style='text-align:center; color:#999;'>Hi√ß anket kaydƒ± bulunamadƒ±.</td></tr>";
              return;
            }

            // Lƒ∞STEYƒ∞ D√ñNG√úYE AL
            res.list.forEach((s, index) => {
              try {
                // 1. G√úVENLƒ∞ DEƒûƒ∞≈ûKENLER (Veri yoksa varsayƒ±lan ata)
                let safeQuestion = s.question || "Soru Yok (ID: " + s.id + ")";
                let safeStatus = s.status || "Bilinmiyor";

                // Katƒ±lƒ±mcƒ± Sayƒ±sƒ± (Array kontrol√º)
                let safeTotal = 0;
                if (s.participants && Array.isArray(s.participants)) {
                  safeTotal = s.participants.length;
                }

                // 2. OY DAƒûILIMINI HESAPLA
                let resultsHtml = `<div style="display:flex; flex-direction:column; gap:5px;">`;

                // Se√ßenekler (options) var mƒ±?
                if (
                  s.options &&
                  Array.isArray(s.options) &&
                  s.options.length > 0
                ) {
                  s.options.forEach((opt, idx) => {
                    // OY SAYISINI G√úVENLƒ∞ AL (Hem string "0" hem sayƒ± 0 kontrol√º)
                    let voteCount = 0;
                    if (s.votes) {
                      // Veritabanƒ± yapƒ±sƒ±na g√∂re deneme yap
                      if (s.votes[idx] !== undefined)
                        voteCount = parseInt(s.votes[idx]);
                      else if (s.votes[String(idx)] !== undefined)
                        voteCount = parseInt(s.votes[String(idx)]);
                    }

                    // Y√ºzde Hesapla
                    let percent =
                      safeTotal > 0
                        ? Math.round((voteCount / safeTotal) * 100)
                        : 0;

                    // HTML √áiz
                    resultsHtml += `
                                <div style="font-size:11px; color:#334155;">
                                   <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                                      <span>${opt}</span>
                                      <span style="font-weight:bold;">${voteCount} Oy (%${percent})</span>
                                   </div>
                                   <div style="width:100%; height:6px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                                      <div style="width:${percent}%; height:100%; background:${
                      percent > 0 ? "#4361ee" : "#cbd5e1"
                    };"></div>
                                   </div>
                                </div>`;
                  });
                } else {
                  resultsHtml =
                    "<span style='color:#ef4444; font-size:10px;'>Se√ßenek verisi bozuk veya yok.</span>";
                }
                resultsHtml += `</div>`;

                // 3. TABLOYA SATIR EKLE
                tbody.innerHTML += `
                        <tr>
                           <td style="font-weight:600; color:#1e293b; width:30%; font-size:13px;">${safeQuestion}</td>
                           <td style="width:40%;">${resultsHtml}</td>
                           <td style="text-align:center; font-weight:bold; width:10%; font-size:14px;">${safeTotal}</td>
                           <td style="width:10%; text-align:center;"><span class="badge badge-success">${safeStatus}</span></td>
                           <td style="width:10%; text-align:center;">
                              <button class="btn btn-danger btn-sm" onclick="deleteSurvey('${s.id}')" title="Sil">
                                <i class="fas fa-trash"></i>
                              </button>
                           </td>
                        </tr>`;
              } catch (rowErr) {
                // Eƒüer bu satƒ±rda hata olursa konsola yaz ama d√∂ng√ºy√º kƒ±rma
                console.error("Satƒ±r Hatasƒ±:", rowErr, s);
                tbody.innerHTML += `<tr><td colspan='5' style='color:red;'>Bu anket y√ºklenirken hata olu≈ütu (ID: ${s.id})</td></tr>`;
              }
            });
          } else {
            tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>Sunucu Hatasƒ±: ${res.message}</td></tr>`;
          }
        } catch (e) {
          console.error("Genel Y√ºkleme Hatasƒ±:", e);
          tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>Baƒülantƒ± veya Kod Hatasƒ±: ${e.message}</td></tr>`;
        }
      }

      // ANKET OLU≈ûTUR
      async function createSurvey() {
        const q = document.getElementById("surveyQuestion").value;
        const o = document.getElementById("surveyOptions").value;
        const r = document.getElementById("surveyReward").value;

        if (!q || !o) return alert("Eksik bilgi.");

        await fetchApi("create_survey", {
          question: q,
          options: o.split(","), // Backend array bekliyor ama string de atsak backend d√ºzeltiyor
          reward: r,
        });

        alert("Anket yayƒ±nlandƒ±!");
        closeModal("modalCreateSurvey");
        loadSurveys();
      }

      // ANKET Sƒ∞L
      async function deleteSurvey(id) {
        if (!confirm("Silinsin mi?")) return;
        await fetchApi("delete_survey", { id: id });
        loadSurveys();
      }

      // ANKET OLU≈ûTUR
      async function createSurvey() {
        const q = document.getElementById("surveyQuestion").value;
        const o = document.getElementById("surveyOptions").value;
        const r = document.getElementById("surveyReward").value;

        if (!q || !o) return alert("Eksik bilgi.");

        await fetchApi("create_survey", {
          question: q,
          options: o.split(","), // Backend array bekliyor ama string de atsak backend d√ºzeltiyor
          reward: r,
        });

        alert("Anket yayƒ±nlandƒ±!");
        closeModal("modalCreateSurvey");
        loadSurveys();
      }

      // ANKET Sƒ∞L
      async function deleteSurvey(id) {
        if (!confirm("Silinsin mi?")) return;
        await fetchApi("delete_survey", { id: id });
        loadSurveys();
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // HTML'deki Sƒ±klƒ±k kutusunu bul
        var frequencySelect = document.getElementById("task_frequency");

        // ID inputunu bul
        var idInput =
          document.querySelector('input[name="custom_task_id"]') ||
          document.querySelector('input[name="task_id"]');

        // Eƒüer kutular sayfada varsa √ßalƒ±≈ütƒ±r
        if (frequencySelect && idInput) {
          // Sayfa ilk a√ßƒ±ldƒ±ƒüƒ±nda da bir kez √ßalƒ±≈ütƒ±r (Varsayƒ±lan se√ßim i√ßin)
          generateID(frequencySelect.value, idInput);

          // Se√ßim deƒüi≈ütiƒüinde √ßalƒ±≈ütƒ±r
          frequencySelect.addEventListener("change", function () {
            generateID(this.value, idInput);
          });
        }

        // ID √úretme Fonksiyonu
        function generateID(secim, inputElement) {
          // Rastgele 4 haneli sayƒ± √ºret
          var randomSayi = Math.floor(1000 + Math.random() * 9000);

          if (secim === "GUNLUK") {
            // G√ºnl√ºk se√ßilirse: gunluk_rutin_4821
            inputElement.value = "gunluk_rutin_" + randomSayi;
          } else if (secim === "HAFTALIK") {
            // Haftalƒ±k se√ßilirse: haftalik_rutin_9123
            inputElement.value = "haftalik_rutin_" + randomSayi;
          } else {
            // Tek Seferlik se√ßilirse: gorev_genel_5678
            inputElement.value = "gorev_genel_" + randomSayi;
          }
        }
      });
    </script>
    <div id="modalEditStoreItem" class="modal">
      <div class="modal-content">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0">√úr√ºn√º D√ºzenle</h3>
          <span
            onclick="closeModal('modalEditStoreItem')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>

        <input type="hidden" id="editStId" />

        <div class="form-group">
          <label>√úr√ºn Ba≈ülƒ±ƒüƒ±</label>
          <input type="text" id="editStTitle" />
        </div>

        <div class="form-group">
          <label>Puan Bedeli (XP)</label>
          <input type="number" id="editStCost" />
        </div>

        <div class="form-group">
          <label>Stok Adedi (Sƒ±nƒ±rsƒ±z i√ßin 9999 yaz)</label>
          <input type="number" id="editStStock" />
        </div>

        <div class="form-group">
          <label style="color: #e67e22; font-weight: bold"
            >Tanƒ±mlƒ± Kupon Kodu</label
          >
          <input
            type="text"
            id="editStCode"
            placeholder="√ñrn: YAZ15 (Bo≈üsa OTOMATIK yazar)"
          />
          <small style="color: #666; font-size: 11px"
            >M√º≈üteri satƒ±n alƒ±nca bu kodu g√∂recek.</small
          >
        </div>

        <div class="form-group">
          <label>Tip</label>
          <select id="editStType">
            <option value="coupon_code">Dijital Kupon</option>
            <option value="physical_gift">Fiziksel Hediye</option>
            <option value="hak_paketi">√áekili≈ü Hakkƒ±</option>
            <option value="chest">≈ûans Kutusu</option>
          </select>
        </div>

        <div class="form-group">
          <label>Gerekli Seviye</label>
          <select id="editStLevel">
            <option value="√áaylak">Herkes</option>
            <option value="Usta">Usta ve √úzeri</option>
            <option value="≈ûampiyon">≈ûampiyon ve √úzeri</option>
            <option value="Efsane">Sadece Efsane</option>
          </select>
        </div>

        <button
          class="btn btn-success"
          style="width: 100%"
          onclick="submitStoreUpdate()"
        >
          Deƒüi≈üiklikleri Kaydet
        </button>
      </div>
    </div>
    <!-- OTO-Pƒ∞LOT MODALI (FULL VERSƒ∞YON) -->
    <div id="modalAutoRaffle" class="modal">
      <div
        class="modal-content"
        style="width: 550px; max-height: 85vh; overflow-y: auto"
      >
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h3 style="margin: 0; color: #f59e0b">
            <i class="fas fa-robot"></i> Otomatik √áekili≈ü Fabrikasƒ±
          </h3>
          <span
            onclick="closeModal('modalAutoRaffle')"
            style="cursor: pointer; font-size: 1.5rem"
            >&times;</span
          >
        </div>

        <div
          style="
            font-size: 12px;
            color: #64748b;
            margin-bottom: 15px;
            background: #fffbeb;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #fcd34d;
          "
        >
          <i class="fas fa-info-circle"></i> <b>Nasƒ±l √áalƒ±≈üƒ±r?</b> Ba≈ülangƒ±√ß
          tarihini se√ß ve anahtarƒ± a√ß. Sistem o tarih gelince √ßekili≈üi √ºretir.
          Durdurmak i√ßin anahtarƒ± kapatƒ±p kaydedin.
        </div>

        <!-- 1. G√úNL√úK AYARLAR -->
        <div
          style="
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <strong
              style="
                color: #334155;
                display: flex;
                align-items: center;
                gap: 5px;
              "
              ><i class="fas fa-calendar-day" style="color: #3b82f6"></i> G√úNL√úK
              √áEKƒ∞Lƒ∞≈û</strong
            >
            <label class="switch" style="margin-bottom: 0">
              <input type="checkbox" id="ar_daily_active" />
              <span class="slider round"></span>
            </label>
          </div>
          <div
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px"
          >
            <div>
              <label style="font-size: 10px">Ba≈ülangƒ±√ß Tarihi</label
              ><input
                type="date"
                id="ar_daily_date"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">Ki≈üi Sayƒ±sƒ±</label
              ><input
                type="number"
                id="ar_daily_winners"
                placeholder="5"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">√ñd√ºl (TL)</label
              ><input
                type="number"
                id="ar_daily_amount"
                placeholder="150"
                class="form-control"
                style="width: 100%"
              />
            </div>
          </div>
        </div>

        <!-- 2. HAFTALIK AYARLAR -->
        <div
          style="
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <strong
              style="
                color: #334155;
                display: flex;
                align-items: center;
                gap: 5px;
              "
              ><i class="fas fa-calendar-week" style="color: #8b5cf6"></i>
              HAFTALIK √áEKƒ∞Lƒ∞≈û</strong
            >
            <label class="switch" style="margin-bottom: 0">
              <input type="checkbox" id="ar_weekly_active" />
              <span class="slider round"></span>
            </label>
          </div>
          <div
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px"
          >
            <div>
              <label style="font-size: 10px">Ba≈ülangƒ±√ß Tarihi</label
              ><input
                type="date"
                id="ar_weekly_date"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">Ki≈üi Sayƒ±sƒ±</label
              ><input
                type="number"
                id="ar_weekly_winners"
                placeholder="3"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">√ñd√ºl (TL)</label
              ><input
                type="number"
                id="ar_weekly_amount"
                placeholder="250"
                class="form-control"
                style="width: 100%"
              />
            </div>
          </div>
        </div>

        <!-- 3. AYLIK AYARLAR -->
        <div
          style="
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <strong
              style="
                color: #334155;
                display: flex;
                align-items: center;
                gap: 5px;
              "
              ><i class="fas fa-calendar-alt" style="color: #ef4444"></i> AYLIK
              √áEKƒ∞Lƒ∞≈û</strong
            >
            <label class="switch" style="margin-bottom: 0">
              <input type="checkbox" id="ar_monthly_active" />
              <span class="slider round"></span>
            </label>
          </div>
          <div
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px"
          >
            <div>
              <label style="font-size: 10px">Ba≈ülangƒ±√ß Tarihi</label
              ><input
                type="date"
                id="ar_monthly_date"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">Ki≈üi Sayƒ±sƒ±</label
              ><input
                type="number"
                id="ar_monthly_winners"
                placeholder="1"
                class="form-control"
                style="width: 100%"
              />
            </div>
            <div>
              <label style="font-size: 10px">√ñd√ºl (TL)</label
              ><input
                type="number"
                id="ar_monthly_amount"
                placeholder="1000"
                class="form-control"
                style="width: 100%"
              />
            </div>
          </div>
        </div>

        <button
          class="btn btn-primary"
          style="width: 100%; padding: 12px; font-size: 16px"
          onclick="saveAutoRaffleSettings()"
        >
          üíæ Ayarlarƒ± Kaydet ve Sistemi G√ºncelle
        </button>
      </div>
    </div>

    <script>
      // --- EKSƒ∞K OLAN ƒ∞LETƒ∞≈ûƒ∞M FONKSƒ∞YONU ---
      async function fetchApi(action, payload = {}) {
        const savedPass = localStorage.getItem("modum_admin_pass");
        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: action,
              adminToken: savedPass,
              ...payload,
            }),
          });
          return await res.json();
        } catch (e) {
          console.error(e);
          return { success: false, message: "Baƒülantƒ± hatasƒ±: " + e };
        }
      }
      // --- D√úZENLEME PENCERESƒ∞Nƒ∞ A√á ---
      function openEditStoreItem(id) {
        // Hangi satƒ±r?
        const row = document.querySelector(`tr[data-id='${id}']`);
        if (!row) return alert("Hata: Satƒ±r bulunamadƒ±.");

        // Veriyi √ßekip modalƒ± dolduruyoruz
        fetch(getApiUrl(), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ islem: "get_store_items" }),
        })
          .then((res) => res.json())
          .then((data) => {
            const item = data.items.find((i) => i.id === id);
            if (item) {
              document.getElementById("editStId").value = item.id;
              document.getElementById("editStTitle").value = item.title;
              document.getElementById("editStCost").value = item.costXP;
              document.getElementById("editStStock").value = item.stock;
              document.getElementById("editStCode").value =
                item.code === "-" || item.code === "OTOMATIK" ? "" : item.code;
              document.getElementById("editStType").value = item.type;
              document.getElementById("editStLevel").value = item.minLevel;

              openModal("modalEditStoreItem");
            }
          });
      }

      // --- G√úNCELLEMEYƒ∞ KAYDET ---
      async function submitStoreUpdate() {
        const id = document.getElementById("editStId").value;
        const btn = document.querySelector("#modalEditStoreItem button");
        btn.innerText = "Kaydediliyor...";
        btn.disabled = true;

        try {
          const res = await fetch(getApiUrl(), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              islem: "update_store_item",
              id: id,
              title: document.getElementById("editStTitle").value,
              cost: document.getElementById("editStCost").value,
              stock: document.getElementById("editStStock").value,
              couponCode: document.getElementById("editStCode").value,
              type: document.getElementById("editStType").value,
              minLevel: document.getElementById("editStLevel").value,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert("‚úÖ Ba≈üarƒ±yla g√ºncellendi!");
            closeModal("modalEditStoreItem");
            loadCouponStore(); // Tabloyu yenile
          } else {
            alert("Hata: " + data.message);
          }
        } catch (e) {
          alert("Hata olu≈ütu.");
        }

        btn.innerText = "Deƒüi≈üiklikleri Kaydet";
        btn.disabled = false;
      }
    </script>
    <!-- ü§ñ MODUM AI ASƒ∞STAN (GARANTƒ∞ VERSƒ∞YON v3.0) -->
    <script>
      window.addEventListener("load", function () {
        // 1. KONSOLDA BENƒ∞ G√ñR
        console.log(
          "%c üöÄ MODUMNET AI Y√úKLENƒ∞YOR... ",
          "background: #4361ee; color: #fff; font-size: 14px; padding: 5px;"
        );

        // 2. Y√ñNETƒ∞Cƒ∞ URL'Sƒ∞Nƒ∞ AL
        function getBackendURL() {
          var input = document.getElementById("apiUrlInput");
          return input ? input.value : "https://api-hjen5442oq-uc.a.run.app";
        }

        // 3. HTML'ƒ∞ OLU≈ûTUR
        var aiHTML = `
    <div id="admin-ai-widget" style="position:fixed; bottom:25px; right:25px; z-index:2147483647; font-family:'Inter', sans-serif;">
        <!-- PENCERE -->
        <div id="ai-chat-window" style="display:none; width:340px; height:500px; background:white; border:1px solid #cbd5e1; border-radius:12px; box-shadow:0 20px 60px rgba(0,0,0,0.4); flex-direction:column; overflow:hidden; margin-bottom:15px;">
            
            <div style="background:#0f172a; color:white; padding:15px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="font-size:20px;">ü§ñ</div>
                    <div>
                        <div style="font-weight:700;">Modum Asistan</div>
                        <div style="font-size:10px; color:#4ade80;">‚óè Online</div>
                    </div>
                </div>
                <div onclick="toggleAI()" style="cursor:pointer; padding:5px; font-size:18px;">&times;</div>
            </div>

            <div id="ai-messages" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc; font-size:13px; color:#334155; display:flex; flex-direction:column; gap:10px;">
                <div style="background:white; padding:12px; border-radius:12px 12px 12px 0; border:1px solid #e2e8f0; align-self:flex-start; max-width:85%; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                    Merhaba Patron! üëã<br>Sistem verilerine eri≈ütim.
                    <br><br>
                    üëâ <b>"Bug√ºn ciro ne kadar?"</b><br>
                    üëâ <b>"Havuzda ne var?"</b><br>
                    gibi sorular sorabilirsin.
                </div>
            </div>

            <div style="padding:15px; background:white; border-top:1px solid #e2e8f0; display:flex; gap:8px;">
                <input id="ai-input" type="text" placeholder="Bir soru sor..." style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px; outline:none;">
                <button onclick="sendToAI()" style="background:#4361ee; color:white; border:none; width:45px; border-radius:8px; cursor:pointer; font-size:16px;">‚û§</button>
            </div>
        </div>

        <!-- BUTON (ZIPLAYAN) -->
        <div onclick="toggleAI()" style="width:65px; height:65px; background:#4361ee; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 5px 25px rgba(67, 97, 238, 0.6); border:3px solid white; animation: bounceAI 2s infinite;">
            <span style="font-size:32px;">ü§ñ</span>
        </div>
    </div>
    <style>@keyframes bounceAI { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }</style>
    `;

        // Eski varsa temizle (Temiz kurulum)
        var oldWidget = document.getElementById("admin-ai-widget");
        if (oldWidget) oldWidget.remove();

        // Sayfaya ekle
        document.body.insertAdjacentHTML("beforeend", aiHTML);
        console.log("‚úÖ YAPAY ZEKA HTML EKLENDƒ∞.");

        // Fonksiyonlarƒ± Window'a Tanƒ±mla
        window.toggleAI = function () {
          var win = document.getElementById("ai-chat-window");
          if (win.style.display === "none") {
            win.style.display = "flex";
            setTimeout(() => document.getElementById("ai-input").focus(), 100);
          } else {
            win.style.display = "none";
          }
        };

        window.sendToAI = async function () {
          var input = document.getElementById("ai-input");
          var msgArea = document.getElementById("ai-messages");
          var txt = input.value.trim();
          if (!txt) return;

          // Mesajƒ± Ekle
          msgArea.innerHTML += `<div style="background:#4361ee; color:white; padding:12px; border-radius:12px 12px 0 12px; align-self:flex-end; max-width:85%; box-shadow:0 2px 5px rgba(67, 97, 238, 0.2);">${txt}</div>`;
          input.value = "";
          msgArea.scrollTop = msgArea.scrollHeight;

          // Y√ºkleniyor...
          var loadId = "ai-load-" + Date.now();
          msgArea.innerHTML += `<div id="${loadId}" style="align-self:flex-start; color:#94a3b8; font-size:11px; margin-left:5px; margin-bottom:5px;"><i class="fas fa-circle-notch fa-spin"></i> D√º≈ü√ºn√ºyor...</div>`;
          msgArea.scrollTop = msgArea.scrollHeight;

          try {
            console.log("üì° Backend'e soruluyor:", txt);
            // URL SONUNA ISLEM PARAMETRESƒ∞ EKLƒ∞YORUZ Kƒ∞ GARANTƒ∞ OLSUN
            // (Senin sistemin POST body'den okuyor ama biz garantiye alalƒ±m)
            const res = await fetch(getBackendURL(), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                islem: "chatWithAI",
                message: txt,
                userEmail: "info@modum.tr", // Patron Kimliƒüi
              }),
            });
            const data = await res.json();

            document.getElementById(loadId).remove();

            if (data.success) {
              msgArea.innerHTML += `<div style="background:white; padding:12px; border-radius:12px 12px 12px 0; border:1px solid #e2e8f0; align-self:flex-start; max-width:90%; color:#334155; line-height:1.5; box-shadow:0 2px 4px rgba(0,0,0,0.02);">${data.answer}</div>`;
            } else {
              msgArea.innerHTML += `<div style="color:red; font-size:11px; text-align:center;">Hata: ${
                data.answer || "Bilinmiyor"
              }</div>`;
            }
            msgArea.scrollTop = msgArea.scrollHeight;
          } catch (e) {
            console.error("AI Hatasƒ±:", e);
            if (document.getElementById(loadId))
              document.getElementById(loadId).remove();
            msgArea.innerHTML += `<div style="color:red; font-size:11px; text-align:center;">Baƒülantƒ± hatasƒ±! (Konsola bak)</div>`;
          }
        };

        // Enter Tu≈üu
        document
          .getElementById("ai-input")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") window.sendToAI();
          });

        // üö® KONTROL UYARISI (Eƒüer bu √ßƒ±karsa kod √ßalƒ±≈üƒ±yordur)
        // alert("ROBOT Y√úKLENDƒ∞! Saƒü altta mavi butonu g√∂r√ºyor musun?");
      });
    </script>
  </body>
</html>
